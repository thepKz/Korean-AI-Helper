<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HangulMate - H·ªçc Ti·∫øng H√†n</title>
    <!-- S·ª≠ d·ª•ng b·∫£n Tailwind minified ph√π h·ª£p cho production -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f0f5ff;
        }
        .result-section {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .result-section:hover {
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }
        .result-section h3 {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #1e40af;
            display: flex;
            align-items: center;
            gap: 0.5rem;
                font-size: 1.1rem;
            }
        #loading {
            display: none;
            text-align: center;
            padding: 1.5rem;
        }
        #loading .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Th√™m style cho upload */
        #image-preview {
            max-width: 150px;
            max-height: 150px;
            margin-top: 10px;
            display: none; /* ·∫®n ban ƒë·∫ßu */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        /* Style cho c√°c b·∫£ng t·ª´ v·ª±ng, ng·ªØ ph√°p */
        .vocab-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        .vocab-table th {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem;
            text-align: left;
        }
        .vocab-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .vocab-table tr:hover {
            background-color: #f8fafc;
        }
        /* Style cho c√°c v√≠ d·ª• */
        .example-item {
            background-color: #f8fafc;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #3b82f6;
        }
        /* Style cho ph√°t √¢m */
        .pronunciation-guide {
            background-color: #fff7ed;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px dashed #f97316;
            margin: 0.5rem 0;
            font-family: 'Courier New', monospace;
        }
        .pronunciation-controls {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .pronunciation-speed {
            width: 120px;
        }
        .pronunciation-button {
            background-color: #f97316;
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        .pronunciation-button:hover {
            background-color: #ea580c;
        }
        .pronunciation-settings {
            margin-left: auto;
            cursor: pointer;
            color: #f97316;
            transition: transform 0.2s;
        }
        .pronunciation-settings:hover {
            transform: rotate(90deg);
        }
        .pronunciation-settings-panel {
            background-color: #fff;
            border: 1px solid #f3f4f6;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }
        .pronunciation-word-by-word {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .pronunciation-word {
            background-color: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .pronunciation-word:hover {
            background-color: #e5e7eb;
        }
        .pronunciation-word .play-icon {
            color: #f97316;
            font-size: 0.75rem;
        }
        .expand-knowledge-btn {
            display: inline-flex;
            align-items: center;
            background-color: #dbeafe;
            color: #2563eb;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        .expand-knowledge-btn:hover {
            background-color: #bfdbfe;
        }
        .expand-knowledge-content {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            display: none;
        }
        .token-highlight {
            display: inline-block;
            background-color: #ffedd5;
            padding: 0 0.25rem;
            border-radius: 0.25rem;
            margin: 0 0.1rem;
        }
        /* Style cho tooltip nghƒ©a t·ª´ */
        .word-tooltip {
            position: relative;
            cursor: pointer;
            border-bottom: 1px dashed #3b82f6;
            display: inline-block;
        }

        .word-tooltip .tooltip-content {
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 250px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 100;
            border: 1px solid #e5e7eb;
        }

        .word-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        .word-tooltip .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }

        .word-meaning {
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .word-romanization {
            color: #6b7280;
            font-style: italic;
            font-size: 0.875rem;
        }

        .word-pos {
            margin-top: 0.25rem;
            display: inline-block;
            padding: 0.125rem 0.5rem;
            background-color: #f3f4f6;
            border-radius: 9999px;
            font-size: 0.75rem;
            color: #4b5563;
        }

        /* Tooltip ch·∫∑n s·ª± ki·ªán click c·ªßa parent element */
        .word-tooltip .tooltip-content * {
            pointer-events: auto;
        }

        /* Highlight t·ª´ v·ª±ng khi hover */
        .korean-word {
            transition: background-color 0.2s;
            border-radius: 0.25rem;
            padding: 0 0.25rem;
        }

        .korean-word:hover {
            background-color: #dbeafe;
        }

        /* Errors v√† warnings */
        .error-container {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            color: #b91c1c;
        }

        .warning-container {
            background-color: #fff7ed;
            border-left: 4px solid #f97316;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            color: #c2410c;
        }

        /* Container cho c√¥ng th·ª©c ng·ªØ ph√°p */
        .formula-container {
            background-color: #ecfdf5;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            border-left: 4px solid #10b981;
        }

        .formula-title {
            font-weight: 600;
            color: #10b981;
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .formula-content {
            font-family: 'Courier New', monospace;
            background-color: white;
            padding: 0.75rem;
            border-radius: 0.25rem;
            border: 1px solid #d1fae5;
        }

        /* Style cho chat container */
        .chat-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 0.5rem;
            max-width: 100%;
            margin: 0 auto;
        }

        .chat-message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            flex-direction: row;
        }

        .chat-message.other {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .chat-message.user .chat-avatar {
            background-color: #dbeafe;
            color: #2563eb;
        }

        .chat-message.other .chat-avatar {
            background-color: #fef3c7;
            color: #d97706;
        }

        .chat-bubble {
            background-color: white;
            border-radius: 1rem;
            padding: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-width: 80%;
            position: relative;
        }

        .chat-message.user .chat-bubble {
            border-bottom-left-radius: 0.25rem;
            border: 1px solid #dbeafe;
        }

        .chat-message.other .chat-bubble {
            border-bottom-right-radius: 0.25rem;
            border: 1px solid #fef3c7;
        }

        .chat-header {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #6b7280;
        }

        .chat-message.user .chat-header {
            color: #2563eb;
        }

        .chat-message.other .chat-header {
            color: #d97706;
        }

        .chat-text {
            line-height: 1.5;
        }

        /* Style cho examples container */
        .examples-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .example-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            transition: all 0.2s ease-in-out;
        }

        .example-item:hover {
            border-color: #93c5fd;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .korean-text {
            font-size: 1.125rem;
            color: #1e40af;
            font-weight: 500;
        }

        .roman-text {
            color: #6b7280;
            font-style: italic;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .meaning-text {
            color: #374151;
        }

        .note-text {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: #f3f4f6;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        /* Animations for examples */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .example-item {
            animation: fadeInUp 0.3s ease-in-out forwards;
            opacity: 0;
        }

        .example-item:nth-child(1) { animation-delay: 0.1s; }
        .example-item:nth-child(2) { animation-delay: 0.2s; }
        .example-item:nth-child(3) { animation-delay: 0.3s; }
        .example-item:nth-child(4) { animation-delay: 0.4s; }
        .example-item:nth-child(5) { animation-delay: 0.5s; }

        /* Style cho voice recorder */
        .voice-recorder-container {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .voice-record-button {
            background-color: #0ea5e9;
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }

        .voice-record-button:hover {
            background-color: #0284c7;
        }

        .voice-record-button.recording {
            background-color: #ef4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .voice-feedback-container {
            margin-top: 1rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
        }

        .voice-feedback-score {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .voice-feedback-score .score-number {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .voice-feedback-details {
            padding: 0.75rem;
            border-radius: 0.375rem;
            background-color: #f9fafb;
            margin-top: 0.5rem;
        }

        .syllable-feedback {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .syllable-feedback .syllable {
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .syllable-feedback .accuracy {
            margin-left: auto;
        }

        .syllable-feedback .accuracy-bar {
            height: 0.5rem;
            width: 100px;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            margin-left: 0.5rem;
        }

        .syllable-feedback .accuracy-fill {
            height: 100%;
            border-radius: 9999px;
        }

        /* Level indicators */
        .syllable-perfect .accuracy-fill {
            background-color: #10b981;
        }

        .syllable-good .accuracy-fill {
            background-color: #3b82f6;
        }

        .syllable-fair .accuracy-fill {
            background-color: #f59e0b;
        }

        .syllable-poor .accuracy-fill {
            background-color: #ef4444;
        }

        /* Animations */
        .wave-animation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 24px;
        }

        .wave-animation span {
            width: 3px;
            height: 100%;
            background-color: #3b82f6;
            border-radius: 3px;
            animation: wave 1s infinite ease-in-out;
        }

        .wave-animation span:nth-child(2) {
            animation-delay: 0.1s;
        }

        .wave-animation span:nth-child(3) {
            animation-delay: 0.2s;
        }

        .wave-animation span:nth-child(4) {
            animation-delay: 0.3s;
        }

        .wave-animation span:nth-child(5) {
            animation-delay: 0.4s;
        }

        @keyframes wave {
            0%, 100% { transform: scaleY(0.2); }
            50% { transform: scaleY(1); }
        }
        
        /* Style cho ph·∫ßn hi·ªÉn th·ªã ph√°t √¢m */
        .korean-phonetic-word {
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            background-color: #fff;
            border: 1px solid rgba(251, 191, 36, 0.3);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .korean-phonetic-word .korean-word-text {
            font-size: 1.125rem;
            color: #92400e;
            font-weight: 500;
        }
        
        .korean-phonetic-word .korean-word-phonetic {
            color: #6b7280;
            font-size: 0.875rem;
            font-style: italic;
        }
        
        .pronunciation-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            background-color: #fef3c7;
            color: #d97706;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.25rem 0.5rem;
            border: none;
            outline: none;
        }
        
        .pronunciation-button:hover {
            background-color: #fbbf24;
            color: #fff;
        }
        
        .pronunciation-button.playing {
            background-color: #fbbf24;
            color: #fff;
            animation: pulse 2s infinite;
        }
        
        .pronunciation-button.large {
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
        }
        
        .pronunciation-button.small {
            padding: 0.25rem 0.375rem;
            font-size: 0.75rem;
        }
        
        .playing-text {
            background-color: #fef3c7;
            border-radius: 0.25rem;
            padding: 0 0.25rem;
            animation: highlight-pulse 2s infinite;
        }
        
        .pronunciation-segment {
            display: inline-flex;
            align-items: center;
            margin: 0.125rem;
            padding: 0.25rem 0.5rem;
            background-color: #fffbeb;
            border-radius: 0.375rem;
            border: 1px solid rgba(251, 191, 36, 0.2);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .pronunciation-segment:hover {
            background-color: #fef3c7;
            border-color: rgba(251, 191, 36, 0.5);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(251, 191, 36, 0); }
            100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
        }
        
        @keyframes highlight-pulse {
            0% { background-color: #fef3c7; }
            50% { background-color: #fde68a; }
            100% { background-color: #fef3c7; }
        }
        
        /* C·∫£i thi·ªán giao di·ªán container ph√°t √¢m */
        .pronunciation-guide {
            background-color: #fffbeb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        /* C·∫£i thi·ªán style cho t·ª´ng t·ª´ ti·∫øng H√†n ri√™ng bi·ªát */
        .korean-word {
            color: #1e40af;
            font-weight: 500;
        }
        
        /* Style cho c√°c v√≠ d·ª• ph√°t √¢m */
        .pronunciation-examples {
            margin-top: 1rem;
        }
        
        .pronunciation-block {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background-color: #fff;
            border-radius: 0.5rem;
            border: 1px solid rgba(251, 191, 36, 0.2);
            margin-bottom: 0.5rem;
        }
        
        .pronunciation-text {
            flex: 1;
        }
        
        .korean-text {
            font-weight: 500;
            color: #92400e;
            margin-bottom: 0.25rem;
        }
        
        .pronunciation-phonetics {
            font-size: 0.875rem;
            color: #6b7280;
            font-style: italic;
        }
        
        .example-translation {
            color: #4b5563;
            font-size: 0.875rem;
        }
        
        /* Style cho v√≠ d·ª• */
        .examples-container {
            margin-top: 1rem;
        }
        
        .example-item {
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
            background-color: #fff;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.2s ease;
            overflow: hidden;
        }
        
        .example-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-color: rgba(59, 130, 246, 0.4);
        }
        
        .example-content {
            padding: 0.75rem;
            flex: 1;
        }
        
        .example-korean {
            font-weight: 500;
            color: #1e40af;
            margin-bottom: 0.25rem;
            font-size: 1.05rem;
        }
        
        .example-pronunciation {
            color: #6b7280;
            font-size: 0.875rem;
            font-style: italic;
            margin-bottom: 0.25rem;
        }
        
        .example-translation {
            color: #4b5563;
        }
        
        .note-text {
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            background-color: rgba(251, 191, 36, 0.1);
            border-radius: 0.25rem;
            font-size: 0.875rem;
            color: #92400e;
        }
        
        /* N√∫t ph√°t √¢m trong v√≠ d·ª• */
        .example-item .pronunciation-button {
            background-color: #eff6ff;
            color: #3b82f6;
            border-radius: 9999px;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        
        .example-item .pronunciation-button:hover {
            background-color: #3b82f6;
            color: #fff;
            transform: scale(1.05);
        }
        
        /* L√†m ƒë·∫πp tr∆∞·ªùng h·ª£p c√≥ phi√™n √¢m */
        .korean-phonetic-word .korean-word-text {
            font-size: 1.125rem;
            color: #1e40af;
            font-weight: 500;
        }
        
        /* Animation cho v√≠ d·ª• */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .example-item {
            animation: fadeInUp 0.5s ease forwards;
        }

        /* Style cho thanh ƒëi·ªÅu ch·ªânh t·ªëc ƒë·ªô ph√°t √¢m */
        #global-pronunciation-settings {
            background-color: #ffffff;
            border: 1px solid #93c5fd;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 0.75rem;
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 50;
            transition: all 0.3s ease;
            opacity: 0.9;
        }
        
        #global-pronunciation-settings:hover {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        #global-pronunciation-settings label {
            color: #3b82f6;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        #pronunciation-speed {
            -webkit-appearance: none;
            width: 7rem;
            height: 0.5rem;
            background: #e0e7ff;
            border-radius: 0.25rem;
            outline: none;
        }
        
        #pronunciation-speed::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1rem;
            height: 1rem;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        #pronunciation-speed::-moz-range-thumb {
            width: 1rem;
            height: 1rem;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
            border: none;
        }
        
        #pronunciation-speed::-webkit-slider-thumb:hover {
            background: #2563eb;
        }
        
        #pronunciation-speed::-moz-range-thumb:hover {
            background: #2563eb;
        }
        
        #speed-value {
            color: #2563eb;
            font-weight: 600;
            min-width: 2.5rem;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-50 p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-2">üá∞üá∑ HangulMate üá∞üá∑</h1>
        <p class="text-center text-gray-600 mb-6">Ng∆∞·ªùi b·∫°n ƒë·ªìng h√†nh tuy·ªát v·ªùi tr√™n h√†nh tr√¨nh h·ªçc ti·∫øng H√†n c·ªßa b·∫°n</p>
        
        <form id="korean-form" class="mb-6">
            <textarea id="korean-input" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nh·∫≠p c√¢u ti·∫øng H√†n (Ïòà: ÏïàÎÖïÌïòÏÑ∏Ïöî, ÎßåÎÇòÏÑú Î∞òÍ∞ëÏäµÎãàÎã§), ho·∫∑c ƒë·∫∑t c√¢u h·ªèi v·ªÅ ng·ªØ ph√°p (vd: ph√¢n bi·ªát ÏùÄ/Îäî v√† Ïù¥/Í∞Ä)"></textarea>
            
            <!-- Input t·∫£i ·∫£nh -->
            <div class="mt-4">
                <label for="image-upload" class="cursor-pointer bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-md inline-flex items-center transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4V5h12v10zM8.586 8.586a1 1 0 00-1.414 1.414L10 12.414l2.828-2.828a1 1 0 10-1.414-1.414L10 9.586l-1.414-1.414zM10 15a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                        <path d="M10 4a1 1 0 011 1v4.586l1.707-1.707a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 111.414-1.414L9 9.586V5a1 1 0 011-1z" />
                    </svg>
                    T·∫£i ·∫£nh ch·ª©a vƒÉn b·∫£n ti·∫øng H√†n (t√πy ch·ªçn)
                </label>
                <input id="image-upload" type="file" class="hidden" accept="image/*">
                <span id="image-name" class="ml-3 text-sm text-gray-500"></span>
                <img id="image-preview" src="#" alt="Xem tr∆∞·ªõc ·∫£nh">
                </div>
                <br>
            
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 font-medium text-white py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                <span>Ph√¢n t√≠ch</span>
                <i class="fas fa-chevron-right ml-2"></i>
            </button>
            <div class="mt-2"></div>
            <button type="button" id="reset-btn" class="bg-gray-200 hover:bg-gray-300 font-medium text-gray-700 py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                <i class="fas fa-redo-alt mr-2"></i>
                <span>L√†m m·ªõi</span>
            </button>
        </form>

        <!-- H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng t√≠nh nƒÉng mnemonics -->
        <div class="mt-4 mb-6 p-3 bg-purple-50 rounded-lg border border-purple-100">
            <h3 class="flex items-center text-purple-800 font-medium mb-2">
                <i class="fas fa-brain mr-2"></i> Ghi nh·ªõ t·ª´ v·ª±ng v·ªõi Mnemonics
            </h3>
            <p class="text-gray-700 mb-2">G√µ "<span class="font-medium text-purple-700">ghi nh·ªõ t·ª´ 't·ª´_ti·∫øng_h√†n'</span>" ƒë·ªÉ nh·∫≠n c√°c ph∆∞∆°ng ph√°p ghi nh·ªõ hi·ªáu qu·∫£ cho t·ª´ v·ª±ng ƒë√≥.</p>
            <div class="flex flex-wrap gap-2 text-sm">
                <span class="bg-white px-2 py-1 rounded border border-purple-100 cursor-pointer hover:bg-purple-100 transition-colors mnemonic-example">ghi nh·ªõ t·ª´ 'ÏïàÎÖï'</span>
                <span class="bg-white px-2 py-1 rounded border border-purple-100 cursor-pointer hover:bg-purple-100 transition-colors mnemonic-example">nh·ªõ t·ª´ 'ÏÇ¨Îûë'</span>
                <span class="bg-white px-2 py-1 rounded border border-purple-100 cursor-pointer hover:bg-purple-100 transition-colors mnemonic-example">mnemonics 'ÌïôÍµê'</span>
            </div>
        </div>

        <div id="loading">
            <div class="loading-spinner"></div>
            <p class="text-gray-600">ƒêang ph√¢n t√≠ch n·ªôi dung ti·∫øng H√†n...</p>
            </div>
                
        <div id="results" class="hidden">
            <!-- Th√¥ng b√°o l·ªói s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·ªüi JS -->
            <div class="result-section" id="conversation-section" style="display: none;">
                <h3><i class="fas fa-comments text-blue-600"></i> H·ªôi tho·∫°i</h3>
                <div id="conversationContent"></div>
            </div>
            
            <div class="result-section" id="vocab-section" style="display: none;">
                <h3><i class="fas fa-book text-blue-600"></i> T·ª´ v·ª±ng</h3>
                <div id="vocabContent"></div>
        </div>
            
            <div class="result-section" id="grammar-section" style="display: none;">
                <h3><i class="fas fa-feather-alt text-blue-600"></i> Ng·ªØ ph√°p</h3>
                <div id="grammarContent"></div>
                </div>
                
            <div class="result-section" id="translation-section" style="display: none;">
                <h3><i class="fas fa-language text-blue-600"></i> D·ªãch thu·∫≠t</h3>
                <div id="translationContent"></div>
            </div>
            
            <div class="result-section" id="examples-section" style="display: none;">
                <h3><i class="fas fa-lightbulb text-blue-600"></i> V√≠ d·ª•</h3>
                <div id="examplesContent"></div>
            </div>
            
            <div class="result-section" id="culture-section" style="display: none;">
                <h3><i class="fas fa-landmark text-blue-600"></i> VƒÉn h√≥a</h3>
                <div id="cultureContent"></div>
        </div>
            
            <div class="result-section" id="pronunciation-section" style="display: none;">
                <h3><i class="fas fa-volume-up text-blue-600"></i> Ph√°t √¢m</h3>
                <div id="pronunciationContent"></div>
    </div>

            <!-- Th√™m m·ª•c cho b√†i h·ªçc ng·ªØ ph√°p -->
            <div class="result-section" id="lesson-section" style="display: none;">
                <h3><i class="fas fa-chalkboard-teacher text-blue-600"></i> B√†i h·ªçc ng·ªØ ph√°p</h3>
                <h4 id="lessonTopic" class="font-semibold text-lg mb-2 text-blue-800"></h4>
                
                <div id="lesson-definition" class="mb-4">
                    <h5 class="font-medium text-blue-700 mb-2"><i class="fas fa-info-circle mr-1"></i> ƒê·ªãnh nghƒ©a:</h5>
                    <div class="definition-content pl-4 border-l-2 border-blue-200"></div>
                </div>
                
                <div id="lesson-usage" class="mb-4">
                    <h5 class="font-medium text-blue-700 mb-2"><i class="fas fa-cog mr-1"></i> C√°ch d√πng:</h5>
                    <div class="usage-content pl-4 border-l-2 border-blue-200"></div>
                    </div>
                
                <div id="lesson-comparison" class="mb-4">
                    <h5 class="font-medium text-blue-700 mb-2"><i class="fas fa-balance-scale mr-1"></i> So s√°nh:</h5>
                    <div class="comparison-content pl-4 border-l-2 border-blue-200"></div>
                            </div>
                
                <div id="lesson-common_mistakes" class="mb-4">
                    <h5 class="font-medium text-blue-700 mb-2"><i class="fas fa-exclamation-triangle mr-1"></i> L·ªói th∆∞·ªùng g·∫∑p:</h5>
                    <div class="common-mistakes-content pl-4 border-l-2 border-blue-200"></div>
                        </div>
                
                <div id="lesson-examples" class="mb-4">
                    <h5 class="font-medium text-blue-700 mb-2"><i class="fas fa-list-ul mr-1"></i> V√≠ d·ª•:</h5>
                    <div class="examples-content pl-4 border-l-2 border-blue-200"></div>
                    </div>
                
                <div id="lesson-exercise" class="mb-4">
                    <h5 class="font-medium text-blue-700 mb-2"><i class="fas fa-pencil-alt mr-1"></i> B√†i t·∫≠p:</h5>
                    <div class="exercise-content pl-4 border-l-2 border-blue-200"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Th√™m ph·∫ßn mnemonics v√†o ƒë√¢y -->
    <div class="result-section" id="mnemonics-section" style="display: none;">
        <h3><i class="fas fa-brain text-purple-600"></i> Ph∆∞∆°ng ph√°p ghi nh·ªõ</h3>
        <div id="mnemonicsContent" class="space-y-4">
            <!-- N·ªôi dung mnemonics s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·ªüi JS -->
        </div>
    </div>
    
    <footer class="mt-8 text-center text-gray-600 text-sm">
        <p>¬© 2023 HangulMate - H·ªçc ti·∫øng H√†n th√¥ng minh</p>
    </footer>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script>
        const form = document.getElementById('korean-form');
        const input = document.getElementById('korean-input');
        const imageUpload = document.getElementById('image-upload');
        const imageName = document.getElementById('image-name');
        const imagePreview = document.getElementById('image-preview');
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.getElementById('loading');
        
        // L·∫•y t·∫•t c·∫£ c√°c container n·ªôi dung k·∫øt qu·∫£
        const conversationSection = document.getElementById('conversation-section');
        const conversationContent = document.getElementById('conversationContent');
        const vocabSection = document.getElementById('vocab-section');
        const vocabContent = document.getElementById('vocabContent');
        const grammarSection = document.getElementById('grammar-section');
        const grammarContent = document.getElementById('grammarContent');
        const translationSection = document.getElementById('translation-section');
        const translationContent = document.getElementById('translationContent');
        const examplesSection = document.getElementById('examples-section');
        const examplesContent = document.getElementById('examplesContent');
        const cultureSection = document.getElementById('culture-section');
        const cultureContent = document.getElementById('cultureContent');
        const pronunciationSection = document.getElementById('pronunciation-section');
        const pronunciationContent = document.getElementById('pronunciationContent');
        const lessonSection = document.getElementById('lesson-section');
        const lessonTopic = document.getElementById('lessonTopic');
        
        // ƒê·∫∑t c√°c th√†nh ph·∫ßn c·ªßa b√†i h·ªçc
        const lessonSections = {
            definition: document.querySelector('#lesson-definition .definition-content'),
            usage: document.querySelector('#lesson-usage .usage-content'),
            comparison: document.querySelector('#lesson-comparison .comparison-content'),
            common_mistakes: document.querySelector('#lesson-common_mistakes .common-mistakes-content'),
            examples: document.querySelector('#lesson-examples .examples-content'),
            exercise: document.querySelector('#lesson-exercise .exercise-content')
        };
        
        let imageBase64 = null;

        // X·ª≠ l√Ω ch·ªçn file ·∫£nh
        imageUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                try {
                    // Ki·ªÉm tra lo·∫°i file
                    if (!file.type.match('image.*')) {
                        alert("Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh (jpg, png, jpeg).");
                        imageUpload.value = '';
                        return;
                    }
                    
                    // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (t·ªëi ƒëa 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert("K√≠ch th∆∞·ªõc file qu√° l·ªõn. Vui l√≤ng ch·ªçn file nh·ªè h∆°n 5MB.");
                        imageUpload.value = '';
                        return;
                    }
                    
                    imageName.textContent = file.name;
                    
                    // ƒê·ªçc file d∆∞·ªõi d·∫°ng base64
                    const base64Data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = (error) => reject(error);
                        reader.readAsDataURL(file);
                    });
                    
                    imageBase64 = base64Data;
                    
                    if (imagePreview) {
                        imagePreview.src = base64Data;
                        imagePreview.style.display = 'block';
                    }
                    
                } catch (error) {
                    console.error("L·ªói ƒë·ªçc file:", error);
                    alert("Kh√¥ng th·ªÉ ƒë·ªçc file. Vui l√≤ng th·ª≠ l·∫°i v·ªõi file kh√°c.");
                    imageUpload.value = '';
                    imageName.textContent = '';
                }
            } else {
                imageName.textContent = '';
                if (imagePreview) {
                    imagePreview.src = '#';
                    imagePreview.style.display = 'none';
                }
                imageBase64 = null;
            }
        });

        // X·ª≠ l√Ω format n·ªôi dung cho ƒë·∫πp
        function formatContent(text) {
            if (!text) return '';
            // Thay th·∫ø xu·ªëng d√≤ng b·∫±ng th·∫ª <br>
            return text.replace(/\n/g, '<br>');
        }

        // Hi·ªÉn th·ªã t·ª´ v·ª±ng d∆∞·ªõi d·∫°ng b·∫£ng
        function renderVocabularyTable(vocabulary) {
            if (!vocabulary || !Array.isArray(vocabulary) || vocabulary.length === 0) {
                return '<p class="text-gray-500 italic">Kh√¥ng c√≥ th√¥ng tin t·ª´ v·ª±ng.</p>';
            }
            
            let html = `
            <table class="vocab-table">
                <thead>
                    <tr>
                        <th>T·ª´ v·ª±ng</th>
                        <th>Phi√™n √¢m</th>
                        <th>Nghƒ©a</th>
                        <th>Lo·∫°i t·ª´</th>
                        <th>Nghe</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            vocabulary.forEach(item => {
                html += `
                <tr>
                    <td class="font-semibold text-blue-800">
                        ${createWordTooltip(item.hangul || '', item.meaning || '?', item.roman || item.romanization || '?', item.pos || '?')}
                    </td>
                    <td class="text-gray-700 italic">${item.roman || item.romanization || '?'}</td>
                    <td>${item.meaning || '?'}</td>
                    <td><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${item.pos || '?'}</span></td>
                    <td>
                        <button class="pronunciation-button p-1" onclick="speakKorean('${(item.hangul || '').replace(/'/g, "\\'")}')">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </td>
                </tr>
                `;
            });
            
            html += `
                </tbody>
            </table>
            `;
            
            return html;
        }

        // Ph√¢n t√≠ch vƒÉn b·∫£n ƒë·ªÉ th√™m tooltip cho t·ª´ H√†n Qu·ªëc
        function createWordTooltip(word, meaning, romanization, pos) {
            return `
            <span class="word-tooltip korean-word">
                ${word}
                <div class="tooltip-content">
                    <div class="word-meaning">${meaning || 'Kh√¥ng c√≥ nghƒ©a'}</div>
                    <div class="word-romanization">${romanization || ''}</div>
                    ${pos ? `<div class="word-pos">${pos}</div>` : ''}
                    <div class="flex mt-2">
                        <button class="pronunciation-button py-1 px-2 text-xs" onclick="event.stopPropagation(); speakKorean('${word.replace(/'/g, "\\'")}')">
                            <i class="fas fa-play mr-1"></i> Nghe
                        </button>
                    </div>
                </div>
            </span>
            `;
        }

        // Th√™m tooltip cho t·ª´ H√†n Qu·ªëc trong vƒÉn b·∫£n
        function addWordTooltips(text, vocabulary) {
            if (!text || !vocabulary || !Array.isArray(vocabulary)) {
                return text;
            }
            
            // T·∫°o b·∫£n sao ƒë·ªÉ tr√°nh thay ƒë·ªïi c√°c ƒë·ªëi t∆∞·ª£ng ban ƒë·∫ßu
            const vocabMap = {};
            vocabulary.forEach(item => {
                if (item.hangul) {
                    vocabMap[item.hangul] = {
                        meaning: item.meaning || '?',
                        romanization: item.roman || item.romanization || '?',
                        pos: item.pos || '?'
                    };
                }
            });
            
            // T√¨m v√† thay th·∫ø t·ª´ ti·∫øng H√†n trong vƒÉn b·∫£n
            // Regex ƒë·ªÉ t√¨m chu·ªói k√Ω t·ª± H√†n Qu·ªëc (Unicode range: AC00-D7A3 cho Hangul syllables)
            const koreanRegex = /[\uAC00-\uD7A3]+/g;
            
            return text.replace(koreanRegex, (match) => {
                // N·∫øu t·ª´ c√≥ trong danh s√°ch t·ª´ v·ª±ng, th√™m tooltip
                if (vocabMap[match]) {
                    return createWordTooltip(
                        match,
                        vocabMap[match].meaning,
                        vocabMap[match].romanization,
                        vocabMap[match].pos
                    );
                }
                // N·∫øu kh√¥ng, v·∫´n l√†m n·ªïi b·∫≠t nh∆∞ng kh√¥ng c√≥ th√¥ng tin chi ti·∫øt
                return `<span class="korean-word" onclick="lookupWord('${match.replace(/'/g, "\\'")}')">${match}</span>`;
            });
        }

        // H√†m t√¨m ki·∫øm t·ª´ khi ng∆∞·ªùi d√πng nh·∫•p v√†o
        async function lookupWord(word) {
            try {
                // Hi·ªÉn th·ªã h·ªôp tho·∫°i t·∫°m th·ªùi
                const dialog = document.createElement('div');
                dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                dialog.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-lg max-w-md w-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium">Tra c·ª©u: ${word}</h3>
                            <button class="text-gray-500 hover:text-gray-700" onclick="this.parentNode.parentNode.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-4 flex justify-center">
                            <div class="w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                            <span class="ml-2 text-blue-600">ƒêang tra c·ª©u...</span>
                        </div>
                        <div class="flex justify-end mt-4">
                            <button class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded" onclick="this.parentNode.parentNode.remove()">
                                ƒê√≥ng
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(dialog);
                
                // G·ªçi API ƒë·ªÉ l·∫•y th√¥ng tin t·ª´
                // ƒê√¢y l√† ph·∫ßn m·∫´u, trong th·ª±c t·∫ø b·∫°n c√≥ th·ªÉ g·ªçi API c·ªßa m√¨nh ƒë·ªÉ l·∫•y th√¥ng tin t·ª´ v·ª±ng
                const response = await fetch('/analyze_korean', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: word }),
                });
                
                if (!response.ok) {
                    throw new Error(`L·ªói HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                // C·∫≠p nh·∫≠t n·ªôi dung h·ªôp tho·∫°i
                const dialogContent = dialog.querySelector('.bg-white');
                
                if (data.vocabulary && data.vocabulary.length > 0) {
                    const vocabItem = data.vocabulary[0];
                    dialogContent.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium">Tra c·ª©u: ${word}</h3>
                            <button class="text-gray-500 hover:text-gray-700" onclick="this.parentNode.parentNode.parentNode.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-4">
                            <div class="mb-2">
                                <span class="font-bold text-xl text-blue-700">${vocabItem.hangul || word}</span>
                                <span class="ml-2 text-gray-600 italic">${vocabItem.roman || vocabItem.romanization || ''}</span>
                            </div>
                            <div class="mb-2">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${vocabItem.pos || 'Kh√¥ng x√°c ƒë·ªãnh'}</span>
                            </div>
                            <div class="mb-4">
                                <div class="font-medium">Nghƒ©a:</div>
                                <div class="pl-4 border-l-2 border-blue-200">${vocabItem.meaning || 'Kh√¥ng c√≥ th√¥ng tin'}</div>
                            </div>
                            <button class="pronunciation-button py-1 px-3" onclick="speakKorean('${(vocabItem.hangul || word).replace(/'/g, "\\'")}')">
                                <i class="fas fa-play mr-1"></i> Nghe ph√°t √¢m
                            </button>
                        </div>
                        <div class="flex justify-end mt-4">
                            <button class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded" onclick="this.parentNode.parentNode.parentNode.remove()">
                                ƒê√≥ng
                            </button>
                        </div>
                    `;
                } else {
                    dialogContent.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium">Tra c·ª©u: ${word}</h3>
                            <button class="text-gray-500 hover:text-gray-700" onclick="this.parentNode.parentNode.parentNode.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-4">
                            <div class="text-center text-gray-600">
                                <i class="fas fa-info-circle mr-2"></i> Kh√¥ng t√¨m th·∫•y th√¥ng tin t·ª´ v·ª±ng cho "${word}"
                            </div>
                        </div>
                        <div class="flex justify-end mt-4">
                            <button class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded" onclick="this.parentNode.parentNode.parentNode.remove()">
                                ƒê√≥ng
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error("L·ªói khi tra c·ª©u t·ª´:", error);
                alert(`Kh√¥ng th·ªÉ tra c·ª©u t·ª´ "${word}". L·ªói: ${error.message}`);
            }
        }

        // Th√™m h√†m ph√°t √¢m ti·∫øng H√†n (ƒë√£ c·∫≠p nh·∫≠t ƒë·ªÉ x·ª≠ l√Ω l·ªói)
        function speakKorean(text, options = {}) {
            try {
                if (!text || typeof text !== 'string' || text.trim() === '') {
                    console.warn("speakKorean: VƒÉn b·∫£n tr·ªëng ho·∫∑c kh√¥ng h·ª£p l·ªá");
                    return;
                }
                
                // ƒê·∫£m b·∫£o speedInput c√≥ gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng t√¨m th·∫•y
                let speed = 1.0;
                const speedInput = document.getElementById('pronunciation-speed');
                if (speedInput) {
                    speed = parseFloat(speedInput.value);
                }
                
                // ƒê·∫£m b·∫£o t·∫•t c·∫£ c√°c tham s·ªë ƒë·ªÅu c√≥ gi√° tr·ªã h·ª£p l·ªá
                let shouldHighlight = true;
                try {
                    const highlightCheckbox = document.getElementById('highlight-tokens');
                    if (highlightCheckbox) {
                        shouldHighlight = highlightCheckbox.checked;
                    }
                } catch (e) {
                    console.warn("Kh√¥ng th·ªÉ ƒë·ªçc tr·∫°ng th√°i highlight:", e);
                }
                
                // Highlight t·ª´ n·∫øu ƒë∆∞·ª£c y√™u c·∫ßu
                if (shouldHighlight && !options.isWordByWord) {
                    try {
                        highlightText(text);
                    } catch (highlightErr) {
                        console.warn("L·ªói khi highlight text:", highlightErr);
                    }
                }
                
                // Th·ª≠ API c·ªßa server tr∆∞·ªõc
                useServerTTS(text, speed)
                    .catch(e => {
                        console.error("Kh√¥ng th·ªÉ s·ª≠ d·ª•ng ph√°t √¢m server:", e);
                        // N·∫øu API server th·∫•t b·∫°i, th·ª≠ d√πng API c·ªßa tr√¨nh duy·ªát
                        useBrowserTTS(text, speed);
                    });
            } catch (e) {
                console.error("L·ªói trong h√†m speakKorean:", e);
                // Ph∆∞∆°ng √°n d·ª± ph√≤ng
                try {
                    useBrowserTTS(text, speed);
                } catch (fallbackError) {
                    console.error("Kh√¥ng th·ªÉ s·ª≠ d·ª•ng ph√°t √¢m d·ª± ph√≤ng:", fallbackError);
                    alert("Kh√¥ng th·ªÉ ph√°t √¢m vƒÉn b·∫£n. Vui l√≤ng th·ª≠ l·∫°i sau.");
                }
            }
        }

        // H√†m highlight t·ª´ ƒëang ƒë∆∞·ª£c ƒë·ªçc
        function highlightText(text) {
            // T√¨m container ch·ª©a n·ªôi dung ph√°t √¢m
            const container = document.querySelector('.pronunciation-guide');
            if (!container) return;
            
            // T√¨m ph·∫ßn t·ª≠ hi·ªÉn th·ªã vƒÉn b·∫£n ti·∫øng H√†n
            const textElement = container.querySelector('span.font-medium');
            if (!textElement) return;
            
            // L·∫•y vƒÉn b·∫£n g·ªëc
            const originalText = textElement.textContent;
            
            // N·∫øu ƒëang highlight text ƒëang ƒë∆∞·ª£c ƒë·ªçc
            if (text === originalText) {
                // T√°ch t·ª´ng t·ª´ v√† l√†m highlight
                const words = originalText.split(/\s+/);
                let highlightedHTML = '';
                
                words.forEach(word => {
                    highlightedHTML += `<span class="token-highlight">${word}</span> `;
                });
                
                textElement.innerHTML = highlightedHTML.trim();
                
                // Sau 5 gi√¢y, restore l·∫°i text ban ƒë·∫ßu
                setTimeout(() => {
                    textElement.textContent = originalText;
                }, 5000);
            }
        }

        // H√†m ƒë·ªÉ hi·ªÉn th·ªã/·∫©n panel c√†i ƒë·∫∑t ph√°t √¢m
        function togglePronunciationSettings() {
            const settingsPanel = document.getElementById('pronunciation-settings-panel');
            if (settingsPanel) {
                settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
            }
        }

        // H√†m ƒë·ªÉ hi·ªÉn th·ªã/·∫©n n·ªôi dung m·ªü r·ªông ki·∫øn th·ª©c
        function toggleExpandKnowledge() {
            const expandContent = document.getElementById('expand-knowledge-content');
            if (expandContent) {
                const isHidden = expandContent.style.display === 'none' || !expandContent.style.display;
                expandContent.style.display = isHidden ? 'block' : 'none';
                
                // N·∫øu hi·ªÉn th·ªã, l·∫•y d·ªØ li·ªáu m·ªü r·ªông
                if (isHidden) {
                    // L·∫•y vƒÉn b·∫£n ti·∫øng H√†n hi·ªán t·∫°i
                    const koreanText = document.querySelector('.pronunciation-guide span.font-medium')?.textContent || '';
                    
                    if (koreanText) {
                        fetchExpandedKnowledge(koreanText);
                    }
                }
            }
        }

        // H√†m ƒë·ªÉ l·∫•y d·ªØ li·ªáu ki·∫øn th·ª©c m·ªü r·ªông
        async function fetchExpandedKnowledge(text) {
            try {
                const expandContent = document.getElementById('expand-knowledge-content');
                if (!expandContent) return;
                
                expandContent.innerHTML = `
                    <div class="flex justify-center items-center p-3">
                        <div class="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <span class="ml-2 text-blue-600">ƒêang t·∫£i d·ªØ li·ªáu...</span>
                    </div>
                `;
                
                // G·ªçi API ƒë·ªÉ l·∫•y c√°c bi·∫øn th·ªÉ c·ªßa c√¢u
                const response = await fetch('/korean_variations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text }),
                });
                
                if (!response.ok) {
                    throw new Error(`L·ªói HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Hi·ªÉn th·ªã c√°c bi·∫øn th·ªÉ
                let html = `<div class="text-sm font-medium text-blue-800 mb-2">C√°c d·∫°ng t∆∞∆°ng ƒë∆∞∆°ng:</div>
                <div class="p-2 border-l-2 border-blue-200">`;
                
                if (data.variations && Array.isArray(data.variations) && data.variations.length > 0) {
                    data.variations.forEach(variation => {
                        let vietnameseTrans = '';
                        // Ki·ªÉm tra xem c√≥ d·ªãch ti·∫øng Vi·ªát kh√¥ng (th√™m v√†o)
                        if (variation.vietnamese) {
                            vietnameseTrans = `<div class="text-xs text-indigo-600">${variation.vietnamese}</div>`;
                        }
                        
                        html += `
                        <div class="flex items-center mb-3 p-2 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow">
                            <button class="pronunciation-button mr-2 py-1 px-2" onclick="speakKorean('${variation.text.replace(/'/g, "\\'")}')">
                                <i class="fas fa-play mr-1"></i>
                            </button>
                            <div class="flex-grow">
                                <div class="text-indigo-800 font-medium">${variation.text}</div>
                                <div class="text-xs text-gray-600">${variation.description || ''}</div>
                                ${vietnameseTrans}
                            </div>
                            <div class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${variation.level || ''}</div>
                        </div>`;
                    });
                } else {
                    html += `
                    <div class="text-gray-600 italic">Kh√¥ng t√¨m th·∫•y d·∫°ng t∆∞∆°ng ƒë∆∞∆°ng.</div>`;
                }
                
                html += `</div>`;
                
                // Th√™m n√∫t ƒë·ªÉ ng∆∞·ªùi d√πng xem gi·∫£i th√≠ch v·ªÅ s·ª± kh√°c bi·ªát ng·ªØ ph√°p
                html += `
                <div class="mt-3">
                    <button class="expand-knowledge-btn bg-indigo-50 hover:bg-indigo-100" onclick="showGrammarExplanation('${text.replace(/'/g, "\\'")}')">
                        <i class="fas fa-info-circle mr-1"></i> Xem gi·∫£i th√≠ch ng·ªØ ph√°p
                    </button>
                    <div id="grammar-explanation" class="expand-knowledge-content mt-2"></div>
                </div>`;
                
                expandContent.innerHTML = html;
            } catch (error) {
                console.error("L·ªói khi l·∫•y d·ªØ li·ªáu m·ªü r·ªông:", error);
                
                const expandContent = document.getElementById('expand-knowledge-content');
                if (expandContent) {
                    expandContent.innerHTML = `
                    <div class="text-red-600 p-2">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu m·ªü r·ªông: ${error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}
                    </div>
                    <div class="mt-2">
                        <button class="pronunciation-button" onclick="fetchExpandedKnowledge('${text.replace(/'/g, "\\'")}')">
                            <i class="fas fa-sync-alt mr-1"></i> Th·ª≠ l·∫°i
                        </button>
                    </div>
                    `;
                }
            }
        }

        // H√†m ƒë·ªÉ hi·ªÉn th·ªã gi·∫£i th√≠ch ng·ªØ ph√°p
        async function showGrammarExplanation(text) {
            const explanationDiv = document.getElementById('grammar-explanation');
            if (!explanationDiv) return;
            
            if (explanationDiv.style.display === 'block') {
                explanationDiv.style.display = 'none';
                return;
            }
            
            explanationDiv.style.display = 'block';
            explanationDiv.innerHTML = `
                <div class="flex justify-center items-center p-3">
                    <div class="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                    <span class="ml-2 text-blue-600">ƒêang l·∫•y gi·∫£i th√≠ch...</span>
                </div>
            `;
            
            try {
                // G·ªçi API ƒë·ªÉ l·∫•y gi·∫£i th√≠ch ng·ªØ ph√°p
                const response = await fetch('/korean_variations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text }),
                });
                
                if (!response.ok) {
                    throw new Error(`L·ªói HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // L·∫•y gi·∫£i th√≠ch ng·ªØ ph√°p t·ª´ d·ªØ li·ªáu API
                const grammarExplanation = data.grammar_explanation || {};
                
                let explanationHTML = `<div class="text-sm bg-gray-50 p-3 rounded-md">`;
                
                // Gi·∫£i th√≠ch lu·∫≠t ng·ªØ ph√°p
                if (grammarExplanation.rules) {
                    explanationHTML += `
                        <div class="mb-3">
                            <div class="font-medium text-blue-800">Lu·∫≠t ng·ªØ ph√°p:</div>
                            <div class="mt-1 pl-2 border-l-2 border-blue-100">${formatContent(grammarExplanation.rules)}</div>
                        </div>
                    `;
                }
                
                // Gi·∫£i th√≠ch v·ªÅ c√°c c·∫•p ƒë·ªô
                if (grammarExplanation.levels) {
                    explanationHTML += `
                        <div class="mb-3">
                            <div class="font-medium text-blue-800">C·∫•p ƒë·ªô giao ti·∫øp:</div>
                            <div class="mt-1 pl-2 border-l-2 border-blue-100">${formatContent(grammarExplanation.levels)}</div>
                        </div>
                    `;
                }
                
                // Gi·∫£i th√≠ch v·ªÅ c√°c ƒëu√¥i c√¢u
                if (grammarExplanation.endings) {
                    explanationHTML += `
                        <div class="mb-3">
                            <div class="font-medium text-blue-800">ƒêu√¥i k·∫øt th√∫c c√¢u:</div>
                            <div class="mt-1 pl-2 border-l-2 border-blue-100">${formatContent(grammarExplanation.endings)}</div>
                        </div>
                    `;
                }
                
                // V√≠ d·ª•
                if (grammarExplanation.examples) {
                    explanationHTML += `
                        <div class="mb-2">
                            <div class="font-medium text-blue-800">V√≠ d·ª•:</div>
                            <div class="mt-1 pl-2 border-l-2 border-blue-100">${formatContent(grammarExplanation.examples)}</div>
                        </div>
                    `;
                }
                
                explanationHTML += `</div>`;
                
                // Hi·ªÉn th·ªã gi·∫£i th√≠ch
                explanationDiv.innerHTML = explanationHTML || `
                    <div class="text-gray-600 italic p-3">
                        Kh√¥ng c√≥ th√¥ng tin gi·∫£i th√≠ch ng·ªØ ph√°p.
                    </div>
                `;
            } catch (error) {
                console.error("L·ªói khi l·∫•y gi·∫£i th√≠ch ng·ªØ ph√°p:", error);
                explanationDiv.innerHTML = `
                    <div class="text-red-600 p-2">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        Kh√¥ng th·ªÉ l·∫•y gi·∫£i th√≠ch: ${error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}
                    </div>
                `;
            }
        }

        // S·ª≠ d·ª•ng API TTS c·ªßa server
        async function useServerTTS(text, speed) {
            try {
                if (!text || typeof text !== 'string' || text.trim() === '') {
                    return false;
                }
                
                const response = await fetch('/tts_korean', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text, speed }),
                });

                if (!response.ok) {
                    console.warn(`TTS API tr·∫£ v·ªÅ l·ªói HTTP: ${response.status}`);
                    return false;
                }

                const data = await response.json();
                
                if (data.error) {
                    console.warn("API TTS tr·∫£ v·ªÅ l·ªói:", data.error);
                    return false;
                }
                
                if (data.audio) {
                    try {
                        // T·∫°o v√† ph√°t audio t·ª´ base64
                        const audio = new Audio(`data:audio/${data.format};base64,${data.audio}`);
                        
                        // X·ª≠ l√Ω l·ªói khi ph√°t audio
                        audio.onerror = (e) => {
                            console.error("L·ªói khi ph√°t audio:", e);
                            return false;
                        };
                        
                        // Ph√°t audio
                        audio.play().catch(e => {
                            console.error("L·ªói khi ph√°t audio:", e);
                            return false;
                        });
                        
                        return true;
                    } catch (audioErr) {
                        console.error("L·ªói khi x·ª≠ l√Ω audio:", audioErr);
                        return false;
                    }
                }
                
                return false;
            } catch (error) {
                console.error("L·ªói khi g·ªçi API TTS:", error);
                return false;
            }
        }

        // S·ª≠ d·ª•ng Web Speech API c·ªßa tr√¨nh duy·ªát
        function useBrowserTTS(text, speed) {
            if (!text || typeof text !== 'string' || text.trim() === '') {
                console.warn("useBrowserTTS: VƒÉn b·∫£n tr·ªëng ho·∫∑c kh√¥ng h·ª£p l·ªá");
                return;
            }
            
            try {
                const speechSynthesis = window.speechSynthesis;
                if (!speechSynthesis) {
                    console.warn("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ SpeechSynthesis API");
                    return;
                }
                
                // D·ª´ng t·∫•t c·∫£ c√°c ph√°t √¢m ƒëang ch·∫°y
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                
                // X·ª≠ l√Ω l·ªói ph√°t √¢m
                utterance.onerror = (error) => {
                    console.error("L·ªói SpeechSynthesis:", error);
                };
                
                // T√¨m gi·ªçng ti·∫øng H√†n
                let koreanVoice = null;
                const voices = speechSynthesis.getVoices();
                
                for (const voice of voices) {
                    if (voice.lang.includes('ko')) {
                        koreanVoice = voice;
                        break;
                    }
                }
                
                // N·∫øu kh√¥ng t√¨m th·∫•y gi·ªçng ti·∫øng H√†n, d√πng gi·ªçng m·∫∑c ƒë·ªãnh
                utterance.voice = koreanVoice;
                utterance.lang = 'ko-KR';
                
                // X·ª≠ l√Ω t·ªëc ƒë·ªô
                try {
                    utterance.rate = parseFloat(speed) || 1.0;
                    if (isNaN(utterance.rate) || utterance.rate < 0.1 || utterance.rate > 2) {
                        utterance.rate = 1.0;
                    }
                } catch (e) {
                    utterance.rate = 1.0;
                }
                
                // B·∫Øt ƒë·∫ßu ph√°t √¢m
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error("L·ªói khi s·ª≠ d·ª•ng SpeechSynthesis API:", error);
            }
        }

        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ªëc ƒë·ªô ph√°t √¢m khi thay ƒë·ªïi
        document.addEventListener('DOMContentLoaded', function() {
            // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng thay ƒë·ªïi t·ªëc ƒë·ªô ph√°t √¢m
            document.body.addEventListener('input', function(e) {
                if (e.target && e.target.id === 'pronunciation-speed') {
                    const speedValue = document.getElementById('speed-value');
                    if (speedValue) {
                        speedValue.textContent = parseFloat(e.target.value).toFixed(1) + 'x';
                    }
                }
            });
            
            // Kh·ªüi t·∫°o danh s√°ch gi·ªçng n√≥i n·∫øu c·∫ßn
            if ('speechSynthesis' in window) {
                // N·∫øu danh s√°ch gi·ªçng n√≥i ƒë√£ s·∫µn s√†ng
                if (window.speechSynthesis.getVoices().length > 0) {
                    // ƒê√£ c√≥ danh s√°ch gi·ªçng n√≥i
                }
                // N·∫øu danh s√°ch gi·ªçng n√≥i ch∆∞a s·∫µn s√†ng, ƒëƒÉng k√Ω s·ª± ki·ªán
                window.speechSynthesis.onvoiceschanged = function() {
                    // Danh s√°ch gi·ªçng n√≥i ƒë√£ s·∫µn s√†ng
                };
            }
        });

        // X·ª≠ l√Ω form submit
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const koreanText = input.value.trim();
            
            // Ki·ªÉm tra xem c√≥ n·ªôi dung ƒë·ªÉ g·ª≠i kh√¥ng
            if (!koreanText && !imageBase64) {
                alert('Vui l√≤ng nh·∫≠p vƒÉn b·∫£n ti·∫øng H√†n ho·∫∑c t·∫£i ·∫£nh l√™n.');
                return;
            }
            
            // Ki·ªÉm tra n·∫øu l√† y√™u c·∫ßu mnemonics
            if (koreanText.toLowerCase().includes('nh·ªõ t·ª´') || 
                koreanText.toLowerCase().includes('ghi nh·ªõ') || 
                koreanText.toLowerCase().includes('mnemonics')) {
                
                // Tr√≠ch xu·∫•t t·ª´ v·ª±ng c·∫ßn ghi nh·ªõ t·ª´ input
                const wordMatch = koreanText.match(/nh·ªõ t·ª´\s+["']([^"']+)["']/) || 
                                 koreanText.match(/ghi nh·ªõ\s+["']([^"']+)["']/) || 
                                 koreanText.match(/mnemonics\s+["']([^"']+)["']/);
                
                let word = '';
                if (wordMatch && wordMatch[1]) {
                    word = wordMatch[1].trim();
                } else {
                    // N·∫øu kh√¥ng t√¨m th·∫•y t·ª´ trong pattern c·ª• th·ªÉ, l·∫•y t·ª´ cu·ªëi c√πng
                    const words = koreanText.split(/\s+/);
                    for (let i = words.length - 1; i >= 0; i--) {
                        // Ki·ªÉm tra xem c√≥ ph·∫£i t·ª´ ti·∫øng H√†n kh√¥ng
                        if (/[\uAC00-\uD7A3]/.test(words[i])) {
                            word = words[i].replace(/[.,?!;:'"]/g, '').trim();
                            break;
                        }
                    }
                }
                
                if (!word) {
                    alert('Kh√¥ng th·ªÉ x√°c ƒë·ªãnh t·ª´ v·ª±ng ti·∫øng H√†n c·∫ßn ghi nh·ªõ. Vui l√≤ng th·ª≠ l·∫°i v·ªõi c√∫ ph√°p: "ghi nh·ªõ t·ª´ \'t·ª´_ti·∫øng_h√†n\'"');
                    return;
                }
                
                // Hi·ªÉn th·ªã loading
                loadingDiv.style.display = 'block';
                resultsDiv.classList.add('hidden');
                
                try {
                    // G·ª≠i request t·∫°o mnemonics
                    const response = await fetch('/create_mnemonics_api', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text: word })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        alert(data.error);
                    } else {
                        // Hi·ªÉn th·ªã ph∆∞∆°ng ph√°p ghi nh·ªõ
                        displayMnemonics(data);
                    }
                } catch (error) {
                    console.error('L·ªói khi t·∫°o mnemonics:', error);
                    alert('ƒê√£ x·∫£y ra l·ªói khi t·∫°o ph∆∞∆°ng ph√°p ghi nh·ªõ. Vui l√≤ng th·ª≠ l·∫°i.');
                } finally {
                    // ·∫®n loading
                    loadingDiv.style.display = 'none';
                    resultsDiv.classList.remove('hidden');
                }
                
                return;
            }
            
            // Ti·∫øp t·ª•c x·ª≠ l√Ω ph√¢n t√≠ch th√¥ng th∆∞·ªùng
            // Hi·ªÉn th·ªã loading
            loadingDiv.style.display = 'block';
            resultsDiv.classList.add('hidden');
            
            // X√≥a th√¥ng b√°o l·ªói c≈©
            resultsDiv.querySelectorAll('.error-message').forEach(el => el.remove());
            
            // Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i ƒëi
            const formData = {
                text: koreanText
            };
            
            // Th√™m ·∫£nh n·∫øu c√≥
            if (imageBase64) {
                try {
                    // Ch·ªâ l·∫•y ph·∫ßn base64 (b·ªè header "data:image/jpeg;base64,")
                    const base64Parts = imageBase64.split(',');
                    if (base64Parts.length > 1) {
                        formData.image = base64Parts[1];
                    } else {
                        formData.image = imageBase64;
                    }
                    
                    // Ki·ªÉm tra d·ªØ li·ªáu base64 c√≥ h·ª£p l·ªá kh√¥ng
                    if (!formData.image || typeof formData.image !== 'string' || formData.image.trim() === '') {
                        console.error("D·ªØ li·ªáu ·∫£nh kh√¥ng h·ª£p l·ªá");
                        throw new Error("D·ªØ li·ªáu ·∫£nh kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i v·ªõi ·∫£nh kh√°c.");
                    }
                } catch (imageError) {
                    console.error("L·ªói x·ª≠ l√Ω ·∫£nh:", imageError);
                    displayError("L·ªói x·ª≠ l√Ω ·∫£nh: " + imageError.message);
                    loadingDiv.style.display = 'none';
                    return;
                }
            }

            try {                
                // G·ªçi API ph√¢n t√≠ch
                const response = await fetch('/analyze_korean', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                // Ki·ªÉm tra l·ªói
                if (data.error) {
                    // Ki·ªÉm tra v√† x·ª≠ l√Ω l·ªói SOURCE_LANG_VI ri√™ng
                    if (data.error === 'SOURCE_LANG_VI' || handleSourceLangError(data.error)) {
                        loadingDiv.style.display = 'none';
                        return;
                    }
                    
                    throw new Error(data.error);
                }
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                displayResults(data);
                
            } catch (error) {
                console.error('L·ªói khi g·ªçi API ph√¢n t√≠ch:', error);
                displayError(`${error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}. Vui l√≤ng th·ª≠ l·∫°i.`);
            } finally {
                // ·∫®n loading
                loadingDiv.style.display = 'none';
            }
        });

        // X·ª≠ l√Ω n√∫t reset
        document.getElementById('reset-btn').addEventListener('click', function() {
            // Reset form
            document.getElementById('korean-form').reset();
            document.getElementById('image-preview').style.display = 'none';
            
            // Reset c√°c ph·∫ßn hi·ªán t·∫°i m·ªôt c√°ch an to√†n
            resetResultsSafely();
            
            // ·∫®n k·∫øt qu·∫£
            const resultsDiv = document.getElementById('results');
            if (resultsDiv) {
                resultsDiv.classList.add('hidden');
                
                // X√≥a th√¥ng b√°o l·ªói n·∫øu c√≥
                resultsDiv.querySelectorAll('.error-container, .error-message').forEach(el => el.remove());
            }
            
            // Reset d·ªØ li·ªáu API
            fetch('/reset_chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(response => {
                if (!response.ok) {
                    console.error('L·ªói khi reset chat');
                }
            }).catch(error => {
                console.error('L·ªói:', error);
            });
        });

        // Hi·ªÉn th·ªã k·∫øt qu·∫£ ph√¢n t√≠ch
        function displayResults(data) {
            try {
                // Reset c√°c ph·∫ßn hi·ªán t·∫°i m·ªôt c√°ch an to√†n
                resetResultsSafely();
                
                // L·∫•y c√°c ph·∫ßn t·ª≠ DOM m·ªôt l·∫ßn v√† ki·ªÉm tra t·ªìn t·∫°i
                const conversationSection = validateElement('conversation-section', 'Ph·∫ßn h·ªôi tho·∫°i');
                const conversationContent = validateElement('conversationContent', 'N·ªôi dung h·ªôi tho·∫°i');
                const vocabSection = validateElement('vocab-section', 'Ph·∫ßn t·ª´ v·ª±ng');
                const vocabContent = validateElement('vocabContent', 'N·ªôi dung t·ª´ v·ª±ng');
                const grammarSection = validateElement('grammar-section', 'Ph·∫ßn ng·ªØ ph√°p');
                const grammarContent = validateElement('grammarContent', 'N·ªôi dung ng·ªØ ph√°p');
                const translationSection = validateElement('translation-section', 'Ph·∫ßn d·ªãch thu·∫≠t');
                const translationContent = validateElement('translationContent', 'N·ªôi dung d·ªãch thu·∫≠t');
                const examplesSection = validateElement('examples-section', 'Ph·∫ßn v√≠ d·ª•');
                const examplesContent = validateElement('examplesContent', 'N·ªôi dung v√≠ d·ª•');
                const cultureSection = validateElement('culture-section', 'Ph·∫ßn vƒÉn h√≥a');
                const cultureContent = validateElement('cultureContent', 'N·ªôi dung vƒÉn h√≥a');
                const pronunciationSection = validateElement('pronunciation-section', 'Ph·∫ßn ph√°t √¢m');
                const pronunciationContent = validateElement('pronunciationContent', 'N·ªôi dung ph√°t √¢m');
                const lessonSection = validateElement('lesson-section', 'Ph·∫ßn b√†i h·ªçc');
                const lessonTopic = validateElement('lessonTopic', 'Ch·ªß ƒë·ªÅ b√†i h·ªçc');
                
                // 1. Ph·∫£n h·ªìi giao ti·∫øp
                if (data.conversation_response && conversationSection && conversationContent) {
                    // X·ª≠ l√Ω cu·ªôc h·ªôi tho·∫°i ƒë·∫πp h∆°n
                    if (data.conversation_response.includes('Ng∆∞·ªùi 1') || data.conversation_response.includes('Ng∆∞·ªùi 2')) {
                        const lines = data.conversation_response.split('\n');
                        let chatHTML = '<div class="chat-container">';
                        let currentSpeaker = '';
                        let currentContent = '';

                        lines.forEach(line => {
                            // Ki·ªÉm tra n·∫øu l√† d√≤ng m·ªõi c·ªßa ng∆∞·ªùi n√≥i
                            if (line.startsWith('Ng∆∞·ªùi 1') || line.startsWith('Ng∆∞·ªùi 2')) {
                                // Th√™m n·ªôi dung tr∆∞·ªõc ƒë√≥ v√†o HTML n·∫øu c√≥
                                if (currentSpeaker && currentContent.trim()) {
                                    const isUser = currentSpeaker.includes('Ng∆∞·ªùi 1');
                                    chatHTML += `
                                        <div class="chat-message ${isUser ? 'user' : 'other'}">
                                            <div class="chat-avatar">
                                                <i class="fas fa-${isUser ? 'user' : 'user-friends'}"></i>
                                            </div>
                                            <div class="chat-bubble">
                                                <div class="chat-header">${currentSpeaker}</div>
                                                <div class="chat-text">${currentContent}</div>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                // B·∫Øt ƒë·∫ßu n·ªôi dung m·ªõi
                                currentSpeaker = line.split(':')[0].trim();
                                currentContent = line.substring(line.indexOf(':') + 1).trim();
                            } else {
                                // Th√™m v√†o n·ªôi dung hi·ªán t·∫°i
                                currentContent += '<br>' + line;
                            }
                        });

                        // Th√™m ph·∫ßn cu·ªëi c√πng n·∫øu c√≤n
                        if (currentSpeaker && currentContent.trim()) {
                            const isUser = currentSpeaker.includes('Ng∆∞·ªùi 1');
                            chatHTML += `
                                <div class="chat-message ${isUser ? 'user' : 'other'}">
                                    <div class="chat-avatar">
                                        <i class="fas fa-${isUser ? 'user' : 'user-friends'}"></i>
                                    </div>
                                    <div class="chat-bubble">
                                        <div class="chat-header">${currentSpeaker}</div>
                                        <div class="chat-text">${currentContent}</div>
                                    </div>
                                </div>
                            `;
                        }

                        chatHTML += '</div>';
                        conversationContent.innerHTML = chatHTML;
                    } else {
                        // Tr∆∞·ªùng h·ª£p kh√¥ng ph·∫£i h·ªôi tho·∫°i, d√πng format th√¥ng th∆∞·ªùng
                        conversationContent.innerHTML = formatContent(data.conversation_response);
                    }
                    showElementSafely('conversation-section');
                }

                // 2. B√†i h·ªçc ng·ªØ ph√°p
                if (data.topic && lessonSection && lessonTopic) {
                    lessonTopic.textContent = data.topic;
                    
                    // ƒêi·ªÅn n·ªôi dung cho t·ª´ng ph·∫ßn c·ªßa b√†i h·ªçc
                    if (typeof lessonSections === 'object') {
                        Object.entries(lessonSections).forEach(([key, container]) => {
                            const content = data[key];
                            
                            if (container && content) {
                                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho examples
                                if (key === 'examples' && Array.isArray(content)) {
                                    container.innerHTML = renderExamples(content);
                                } else {
                                    container.innerHTML = formatContent(content);
                                }
                                
                                // Ki·ªÉm tra tr∆∞·ªõc khi truy c·∫≠p thu·ªôc t√≠nh parentNode
                                if (container.parentNode) {
                                    container.parentNode.style.display = 'block';
                                }
                            } else if (container && container.parentNode) {
                                container.parentNode.style.display = 'none';
                            }
                        });
                    }
                    
                    showElementSafely('lesson-section');
                } else {
                    // 3. Ph√¢n t√≠ch ng√¥n ng·ªØ
                    
                    // 3a. T·ª´ v·ª±ng
                    if (data.vocabulary && data.vocabulary.length > 0 && vocabSection && vocabContent) {
                        vocabContent.innerHTML = renderVocabularyTable(data.vocabulary);
                        showElementSafely('vocab-section');
                    }

                    // 3b. Ng·ªØ ph√°p - H·ªó tr·ª£ nhi·ªÅu lu·∫≠t ng·ªØ ph√°p
                    if ((data.grammar || data.grammar_formula) && grammarSection && grammarContent) {
                        grammarContent.innerHTML = data.grammar || data.grammar_formula;
                        showElementSafely('grammar-section');
                    }

                    // 3c. D·ªãch thu·∫≠t
                    if (data.translation && translationSection && translationContent) {
                        translationContent.innerHTML = `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-gray-50 p-3 rounded-md">
                                    <div class="text-gray-600 mb-1 text-sm">Nghƒ©a ƒëen:</div>
                                    <div class="text-gray-800">${data.translation.literal || 'N/A'}</div>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-md">
                                    <div class="text-gray-600 mb-1 text-sm">Nghƒ©a t·ª± nhi√™n:</div>
                                    <div class="text-blue-800 font-medium">${data.translation.natural || 'N/A'}</div>
                                </div>
                                <div class="bg-indigo-50 p-3 rounded-md">
                                    <div class="text-gray-600 mb-1 text-sm flex justify-between">
                                        <span>Nghƒ©a g·ªëc (ti·∫øng H√†n):</span>
                                        ${data.translation.original ? `
                                        <button class="pronunciation-button py-0.5 px-1.5 text-xs" onclick="speakKorean('${data.translation.original.replace(/'/g, "\\'")}')">
                                            <i class="fas fa-play mr-1"></i> Nghe
                                        </button>` : ''}
                                    </div>
                                    <div class="text-indigo-800 font-medium">${data.translation.original || data.translation.korean || 'N/A'}</div>
                                </div>
                            </div>
                        `;
                        showElementSafely('translation-section');
                    }

                    // 3d. V√≠ d·ª•
                    if (data.examples && data.examples.length > 0 && examplesSection && examplesContent) {
                        handleExampleSection(data, examplesSection, examplesContent);
                    }

                    // 3e. VƒÉn h√≥a
                    if (typeof data.culture === 'string' && data.culture.trim() !== '' && cultureSection && cultureContent) {
                        cultureContent.innerHTML = `
                            <div class="bg-yellow-50 p-4 rounded-md border-l-4 border-yellow-400">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-medium text-yellow-800"><i class="fas fa-info-circle mr-1"></i> ƒê·∫∑c ƒëi·ªÉm vƒÉn h√≥a:</h4>
                                    ${data.culture_text ? `
                                    <button class="pronunciation-button py-0.5 px-2 text-xs" onclick="speakKorean('${data.culture_text.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-volume-up mr-1"></i> Nghe
                                    </button>` : ''}
                                </div>
                                <p class="text-yellow-800">${formatContent(data.culture)}</p>
                            </div>
                        `;
                        showElementSafely('culture-section');
                    }

                    // 3f. Ph√°t √¢m
                    if (data.pronunciation && pronunciationSection && pronunciationContent) {
                        // X·ª≠ l√Ω hi·ªÉn th·ªã ph√°t √¢m theo d·∫°ng ch√≠nh ph√≥ng
                        const koreanText = data.text || data.korean || '';
                        let pronunciationDisplay = data.pronunciation;
                        
                        // N·∫øu c√≥ c·∫£ text ti·∫øng H√†n v√† ph√°t √¢m, hi·ªÉn th·ªã theo t·ª´ng t·ª´
                        if (koreanText && data.pronunciation) {
                            try {
                                // C·ªë g·∫Øng hi·ªÉn th·ªã song song
                                pronunciationDisplay = formatKoreanPhonetics(koreanText, data.pronunciation);
                            } catch (e) {
                                console.error('L·ªói khi ƒë·ªãnh d·∫°ng ph√°t √¢m:', e);
                                // Gi·ªØ nguy√™n n·∫øu l·ªói
                            }
                        }
                        
                        // Chu·∫©n b·ªã v√≠ d·ª• ph√°t √¢m n·∫øu c√≥
                        const pronunciationExamples = data.pronunciation_examples || [];
                        const examplesHtml = displayPronunciationExamples(pronunciationExamples);
                        
                        pronunciationContent.innerHTML = `
                            <div class="bg-amber-50 p-4 rounded-md">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-medium text-amber-700"><i class="fas fa-volume-up mr-1"></i> C√°ch ph√°t √¢m:</h4>
                                    <button class="pronunciation-button large" data-text="${koreanText.replace(/"/g, '&quot;')}">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                                <div class="pronunciation-guide p-3 bg-white rounded-md border border-amber-200">
                                    ${pronunciationDisplay}
                                    ${koreanText && !pronunciationDisplay.includes(koreanText) ? 
                                        `<div class="korean-original mt-2">${koreanText}</div>` : ''}
                                </div>
                                ${examplesHtml}
                                <div class="mt-3 text-sm text-amber-600">
                                    <i class="fas fa-info-circle mr-1"></i> Nh·∫•n v√†o n√∫t ph√°t √¢m ƒë·ªÉ nghe v√† luy·ªán ph√°t √¢m chu·∫©n.
                                </div>
                            </div>
                        `;
                        showElementSafely('pronunciation-section');
                        
                        // Kh·ªüi t·∫°o l·∫°i c√°c n√∫t ph√°t √¢m
                        setupPronunciationButtons();
                    }
                }
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                const resultsDiv = document.getElementById('results');
                if (resultsDiv) {
                    resultsDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('L·ªói khi hi·ªÉn th·ªã k·∫øt qu·∫£:', error);
                displayDOMError(`L·ªói khi hi·ªÉn th·ªã k·∫øt qu·∫£: ${error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`, 'results');
            }
        }

        // H√†m format n·ªôi dung
        function formatContent(text) {
            if (!text) return '';
            // Thay th·∫ø xu·ªëng d√≤ng b·∫±ng th·∫ª <br>
            return text.replace(/\n/g, '<br>');
        }

        // Thi·∫øt l·∫≠p c√°c ƒëi·ªÅu khi·ªÉn ph√°t √¢m
        function setupPronunciationControls() {
            // C·∫≠p nh·∫≠t gi√° tr·ªã hi·ªÉn th·ªã t·ªëc ƒë·ªô ph√°t √¢m
            const speedControl = document.getElementById('pronunciation-speed');
            const speedValue = document.getElementById('speed-value');
            
            if (speedControl && speedValue) {
                speedControl.addEventListener('input', function() {
                    speedValue.textContent = `${speedControl.value}x`;
                });
            }
            
            // X·ª≠ l√Ω hi·ªÉn th·ªã/·∫©n b·∫£ng c√†i ƒë·∫∑t
            const settingsToggle = document.querySelector('.pronunciation-settings');
            if (settingsToggle) {
                settingsToggle.addEventListener('click', function() {
                    togglePronunciationSettings();
                });
            }
        }

        // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ mnemonics
        function displayMnemonics(data) {
            try {
                // Reset k·∫øt qu·∫£ hi·ªán t·∫°i
                resetResultsSafely();
                
                // L·∫•y c√°c ph·∫ßn t·ª≠ DOM m·ªôt l·∫ßn v√† ki·ªÉm tra t·ªìn t·∫°i
                const conversationSection = validateElement('conversation-section', 'Ph·∫ßn h·ªôi tho·∫°i');
                const conversationContent = validateElement('conversationContent', 'N·ªôi dung h·ªôi tho·∫°i');
                const mnemonicsSection = validateElement('mnemonics-section', 'Ph·∫ßn ghi nh·ªõ');
                const mnemonicsContent = validateElement('mnemonicsContent', 'N·ªôi dung ghi nh·ªõ');
                
                // Hi·ªÉn th·ªã ph·∫ßn h·ªôi tho·∫°i
                if (conversationSection && conversationContent) {
                    conversationContent.innerHTML = `<p>D∆∞·ªõi ƒë√¢y l√† ph∆∞∆°ng ph√°p ghi nh·ªõ cho t·ª´ v·ª±ng <strong>${data.word}</strong>:</p>`;
                    showElementSafely('conversation-section');
                }
                
                // Hi·ªÉn th·ªã ph·∫ßn mnemonics
                if (mnemonicsSection && mnemonicsContent) {
                    // T·∫°o HTML cho n·ªôi dung mnemonics
                    let mnemonicsHTML = `
                        <div class="bg-purple-50 p-4 rounded-lg mb-4">
                            <h4 class="text-lg font-semibold text-purple-800">${data.word}</h4>
                            <div class="flex justify-between items-center">
                                <p class="text-gray-600 mb-1"><span class="italic">${data.pronunciation}</span> - ${data.meaning}</p>
                                <button class="pronunciation-button py-1 px-2" data-text="${data.word.replace(/"/g, '&quot;')}">
                                    <i class="fas fa-volume-up mr-1"></i> Nghe
                                </button>
                            </div>
                        </div>
                        
                        <div class="methods space-y-3 mb-6">
                            <h4 class="font-medium text-purple-700"><i class="fas fa-lightbulb mr-1"></i> Ph∆∞∆°ng ph√°p ghi nh·ªõ:</h4>
                    `;
                    
                    // Th√™m c√°c ph∆∞∆°ng ph√°p ghi nh·ªõ
                    data.mnemonics.forEach((method, index) => {
                        mnemonicsHTML += `
                            <div class="method bg-white p-3 border border-purple-100 rounded-md">
                                <h5 class="font-medium text-purple-600">${index + 1}. ${method.title}</h5>
                                <p class="text-gray-700 mt-1">${method.description}</p>
                            </div>
                        `;
                    });
                    
                    // Th√™m c√°c v√≠ d·ª•
                    mnemonicsHTML += `
                        <div class="examples mt-4">
                            <h4 class="font-medium text-purple-700 mb-2"><i class="fas fa-list-ul mr-1"></i> V√≠ d·ª•:</h4>
                            <ul class="space-y-2">
                    `;
                    
                    data.examples.forEach(example => {
                        mnemonicsHTML += `
                            <li class="example bg-white p-3 border border-purple-100 rounded-md">
                                <div class="flex justify-between items-center">
                                    <p class="font-medium text-purple-800">${example.korean}</p>
                                    <button class="pronunciation-button py-0.5 px-1.5 text-xs" data-text="${example.korean.replace(/"/g, '&quot;')}">
                                        <i class="fas fa-volume-up mr-1"></i> Nghe
                                    </button>
                                </div>
                                <p class="text-gray-700">${example.vietnamese}</p>
                            </li>
                        `;
                    });
                    
                    mnemonicsHTML += `
                            </ul>
                        </div>
                    `;
                    
                    // Th√™m c√°c t·ª´ li√™n quan
                    mnemonicsHTML += `
                        <div class="related-words mt-4">
                            <h4 class="font-medium text-purple-700 mb-2"><i class="fas fa-project-diagram mr-1"></i> T·ª´ li√™n quan:</h4>
                            <div class="flex flex-wrap gap-2">
                    `;
                    
                    data.related_words.forEach(related => {
                        mnemonicsHTML += `
                            <div class="bg-white px-3 py-1 border border-purple-100 rounded-full flex items-center gap-2">
                                <span class="font-medium text-purple-800">${related.word}</span>
                                <span class="text-gray-600 text-sm"> - ${related.meaning}</span>
                                <button class="pronunciation-button py-0.5 px-1 text-xs ml-1" data-text="${related.word.replace(/"/g, '&quot;')}">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                            </div>
                        `;
                    });
                    
                    mnemonicsHTML += `
                            </div>
                        </div>
                    `;
                    
                    // Ch√®n HTML v√†o container
                    mnemonicsContent.innerHTML = mnemonicsHTML;
                    showElementSafely('mnemonics-section');
                    
                    // Thi·∫øt l·∫≠p c√°c n√∫t ph√°t √¢m
                    if (typeof setupPronunciationButtons === 'function') {
                        setTimeout(() => {
                            setupPronunciationButtons();
                        }, 100);
                    }
                }
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                const resultsDiv = document.getElementById('results');
                if (resultsDiv) {
                    resultsDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('L·ªói khi hi·ªÉn th·ªã k·∫øt qu·∫£ mnemonics:', error);
                displayDOMError(`L·ªói khi hi·ªÉn th·ªã k·∫øt qu·∫£ ghi nh·ªõ: ${error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`, 'mnemonicsContent');
            }
        }

        // H√†m reset k·∫øt qu·∫£ hi·ªán t·∫°i
        function resetResults() {
            // ·∫®n t·∫•t c·∫£ c√°c ph·∫ßn k·∫øt qu·∫£
            document.querySelectorAll('.result-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Reset n·ªôi dung c·ªßa c√°c ph·∫ßn
            conversationContent.innerHTML = '';
            vocabContent.innerHTML = '';
            grammarContent.innerHTML = '';
            translationContent.innerHTML = '';
            examplesContent.innerHTML = '';
            cultureContent.innerHTML = '';
            pronunciationContent.innerHTML = '';
            mnemonicsContent.innerHTML = '';
            
            // Reset n·ªôi dung cho b√†i h·ªçc ng·ªØ ph√°p
            lessonTopic.textContent = '';
            Object.values(lessonSections).forEach(section => {
                section.innerHTML = '';
            });
        }

        // Th√™m s·ª± ki·ªán click cho c√°c v√≠ d·ª• mnemonics
        document.querySelectorAll('.mnemonic-example').forEach(example => {
            example.addEventListener('click', () => {
                input.value = example.textContent;
                input.focus();
                // Cu·ªôn l√™n ƒë·∫ßu form n·∫øu c·∫ßn
                form.scrollIntoView({ behavior: 'smooth' });
            });
        });

        // H√†m hi·ªÉn th·ªã v√† l√†m n·ªïi b·∫≠t t·ª´ ti·∫øng H√†n
        function highlightKoreanWords(text) {
            if (!text) return '';
            
            // T·∫°o regex ƒë·ªÉ nh·∫≠n d·∫°ng c√°c chu·ªói k√Ω t·ª± Hangul
            const koreanRegex = /[\uAC00-\uD7A3]+/g;
            
            // Thay th·∫ø c√°c t·ª´ ti·∫øng H√†n b·∫±ng phi√™n b·∫£n ƒë∆∞·ª£c l√†m n·ªïi b·∫≠t
            return text.replace(koreanRegex, match => {
                return `<span class="korean-word">${match}</span>`;
            });
        }

        // H√†m ƒë·ªçc file d∆∞·ªõi d·∫°ng base64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        }

        // H√†m x·ª≠ l√Ω l·ªói v√† hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        function displayError(message) {
            const errorContainer = document.createElement('div');
            errorContainer.className = 'error-container mb-4';
            errorContainer.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
            
            // X√≥a c√°c th√¥ng b√°o l·ªói c≈© tr∆∞·ªõc khi th√™m m·ªõi
            document.querySelectorAll('.error-container').forEach(element => {
                element.remove();
            });
            
            // Th√™m th√¥ng b√°o l·ªói v√†o tr√™n c√πng c·ªßa k·∫øt qu·∫£
            resultsDiv.prepend(errorContainer);
            resultsDiv.classList.remove('hidden');
        }

        // H√†m ki·ªÉm tra v√† x·ª≠ l√Ω l·ªói SOURCE_LANG_VI
        function handleSourceLangError(error) {
            if (error === 'SOURCE_LANG_VI') {
                displayError('ƒê√£ ph√°t hi·ªán vƒÉn b·∫£n ti·∫øng Vi·ªát. HangulMate ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ ph√¢n t√≠ch vƒÉn b·∫£n ti·∫øng H√†n. Vui l√≤ng nh·∫≠p vƒÉn b·∫£n ti·∫øng H√†n ƒë·ªÉ ƒë∆∞·ª£c ph√¢n t√≠ch.');
                return true;
            }
            return false;
        }

        // Th√™m n√∫t ph√°t √¢m cho v√≠ d·ª• hi·ªÉn th·ªã trong trang
        function setupPronunciationButtons() {
            $('.pronunciation-button').on('click', function(e) {
                e.preventDefault();
                
                // Thi·∫øt l·∫≠p giao di·ªán tr·ª±c quan khi ph√°t √¢m
                $('.pronunciation-button').removeClass('playing');
                $('.playing-text').removeClass('playing-text');
                
                const button = $(this);
                const textElement = button.closest('.example-item, .pronunciation-block').find('.example-korean, .korean-text');
                
                // Highlight text ƒëang ph√°t √¢m
                if (textElement.length) {
                    textElement.addClass('playing-text');
                }
                
                // Th√™m class playing cho button
                button.addClass('playing');
                
                // L·∫•y text ƒë·ªÉ ph√°t √¢m
                const textToSpeak = button.data('text') || button.closest('.example-item, .pronunciation-block').find('.example-korean, .korean-text').text();
                
                if (textToSpeak) {
                    speakKorean(textToSpeak, function() {
                        // Callback khi k·∫øt th√∫c ph√°t √¢m
                        button.removeClass('playing');
                        textElement.removeClass('playing-text');
                    });
                }
            });
        }

        // C·∫≠p nh·∫≠t h√†m speakKorean ƒë·ªÉ h·ªó tr·ª£ callback khi k·∫øt th√∫c
        function speakKorean(text, callback) {
            if (!text) return;
            
            // D·ª´ng ph√°t √¢m hi·ªán t·∫°i n·∫øu c√≥
            window.speechSynthesis.cancel();
            
            // L·∫•y t·ªëc ƒë·ªô ph√°t √¢m t·ª´ thanh tr∆∞·ª£t
            const speedControl = document.getElementById('pronunciation-speed');
            const rate = speedControl ? parseFloat(speedControl.value) : 1.0;
            
            // T·∫°o ƒë·ªëi t∆∞·ª£ng speech
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = rate;
            
            // Th√™m callback khi k·∫øt th√∫c ph√°t √¢m
            if (typeof callback === 'function') {
                utterance.onend = callback;
            }
            
            // B·∫Øt ƒë·∫ßu ph√°t √¢m
            window.speechSynthesis.speak(utterance);
        }

        // C·∫≠p nh·∫≠t h√†m hi·ªÉn th·ªã v√≠ d·ª• ph√°t √¢m
        function displayPronunciationExamples(examples) {
            if (!examples || !examples.length) return '';
            
            let html = '<div class="pronunciation-examples mt-4">';
            html += '<h4 class="font-medium text-amber-700 mb-2"><i class="fas fa-graduation-cap mr-1"></i> V√≠ d·ª• ph√°t √¢m:</h4>';
            
            examples.forEach(example => {
                html += `
                <div class="pronunciation-block">
                    <div class="pronunciation-text">
                        <div class="korean-text">${example.korean}</div>
                        <div class="pronunciation-phonetics">${example.pronunciation || ''}</div>
                        <div class="example-translation text-gray-700 mt-1">${example.vietnamese || ''}</div>
                    </div>
                    <button class="pronunciation-button" data-text="${example.korean.replace(/"/g, '&quot;')}">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // Th√™m c·∫≠p nh·∫≠t cho ph·∫ßn ph√°t √¢m trong b√†i ri√™ng
        function formatPronunciation(text) {
            if (!text) return '';
            
            // T√°ch ph√°t √¢m th√†nh c√°c th√†nh ph·∫ßn c√≥ th·ªÉ nh·∫•n v√†o ƒë·ªÉ nghe
            const segments = text.split(/\s+/);
            let html = '';
            
            segments.forEach(segment => {
                if (segment.trim()) {
                    const hasKorean = /[\uAC00-\uD7A3]/.test(segment);
                    if (hasKorean) {
                        html += `<span class="pronunciation-segment" onclick="speakKorean('${segment.replace(/'/g, "\\'")}')">
                            ${segment} <i class="fas fa-volume-up text-xs text-amber-500"></i>
                        </span> `;
                    } else {
                        html += `<span>${segment}</span> `;
                    }
                }
            });
            
            return html.trim();
        }

        // Kh·ªüi t·∫°o c√°c ch·ª©c nƒÉng khi trang t·∫£i xong
        $(document).ready(function() {
            // ... existing code ...
            setupPronunciationButtons();
            
            // Th√™m thanh ƒëi·ªÅu ch·ªânh t·ªëc ƒë·ªô ph√°t √¢m v√†o body
            $('body').append(speedControlHtml);
            
            // C·∫≠p nh·∫≠t gi√° tr·ªã hi·ªÉn th·ªã khi thay ƒë·ªïi t·ªëc ƒë·ªô
            $('#pronunciation-speed').on('input', function() {
                $('#speed-value').text($(this).val() + 'x');
            });
            
            // Kh·ªüi t·∫°o gi√° tr·ªã ban ƒë·∫ßu
            $('#speed-value').text($('#pronunciation-speed').val() + 'x');
        });

        // C·∫≠p nh·∫≠t ph·∫ßn hi·ªÉn th·ªã v√≠ d·ª• ti·∫øng H√†n trong ph√°t √¢m
        function formatKoreanPhonetics(korean, phonetics) {
            if (!korean || !phonetics) return phonetics || korean || '';
            
            // X·ª≠ l√Ω ƒë·ªãnh d·∫°ng ph√°t √¢m ƒë·∫∑c bi·ªát nh∆∞: Ìò∏Îëê (hodu) [Ti·∫øng Vi·ªát: h√¥ ƒëu]
            // Bi·ªÉu th·ª©c ch√≠nh quy ƒë·ªÉ t√°ch c√°c ph·∫ßn c·ªßa chu·ªói ph√°t √¢m
            const phoneticPattern = /([Í∞Ä-Ìû£]+)\s*\(([^)]+)\)(?:\s*\[Ti·∫øng Vi·ªát:\s*([^\]]+)\])?/g;
            
            let match;
            let formattedHTML = '';
            
            // N·∫øu c√≥ ƒë·ªãnh d·∫°ng ƒë·∫∑c bi·ªát
            if (phoneticPattern.test(phonetics)) {
                // Reset regex index
                phoneticPattern.lastIndex = 0;
                
                // T√°ch t·ª´ng t·ª´ v√† ƒë·ªãnh d·∫°ng ri√™ng bi·ªát
                while ((match = phoneticPattern.exec(phonetics)) !== null) {
                    const koreanWord = match[1];
                    const romanization = match[2];
                    const vietnamPronunciation = match[3] || '';
                    
                    formattedHTML += `
                        <div class="korean-phonetic-word mb-3 bg-white p-3 rounded-md border border-amber-200">
                            <div class="flex items-center justify-between mb-1">
                                <span class="korean-word-text font-medium text-lg text-amber-800">${koreanWord}</span>
                                <button class="pronunciation-button small" data-text="${koreanWord}" onclick="speakKorean('${koreanWord.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                            </div>
                            <div class="text-amber-700 italic">(${romanization})</div>
                            ${vietnamPronunciation ? `<div class="text-gray-600 text-sm mt-1 vietnamese-pronunciation">[Ti·∫øng Vi·ªát: ${vietnamPronunciation}]</div>` : ''}
                    </div>
                `;
            }
                
                return formattedHTML;
            }
            
            // N·∫øu phonetics ch·ª©a nhi·ªÅu t·ª´ c√°ch nhau b·∫±ng d·∫•u ph·∫©y, x·ª≠ l√Ω t·ª´ng t·ª´ ri√™ng bi·ªát
            if (phonetics.includes(',')) {
                const words = phonetics.split(',').map(w => w.trim()).filter(w => w);
                formattedHTML = `<div class="pronunciation-words-container">`;
                
                words.forEach(word => {
                    // T√¨m t·ª´ ti·∫øng H√†n v√† phi√™n √¢m cho m·ªói t·ª´
                    const wordMatch = word.match(/([Í∞Ä-Ìû£]+)\s*\(([^)]+)\)(?:\s*\[Ti·∫øng Vi·ªát:\s*([^\]]+)\])?/);
                    
                    if (wordMatch) {
                        const koreanWord = wordMatch[1];
                        const romanization = wordMatch[2];
                        const vietnamPronunciation = wordMatch[3] || '';
                        
                        formattedHTML += `
                            <div class="pronunciation-word-item mb-2 p-2 border border-amber-100 rounded">
                                <div class="flex items-center justify-between">
                                    <span class="korean-word-text font-medium">${koreanWord}</span>
                                    <button class="pronunciation-button small" data-text="${koreanWord}" onclick="speakKorean('${koreanWord.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                </div>
                                <div class="text-amber-700 italic text-sm">(${romanization})</div>
                                ${vietnamPronunciation ? `<div class="text-gray-600 text-xs vietnamese-pronunciation">[Ti·∫øng Vi·ªát: ${vietnamPronunciation}]</div>` : ''}
                            </div>
                        `;
                    } else {
                        // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p kh√¥ng c√≥ c·∫•u tr√∫c chu·∫©n
                        formattedHTML += `
                            <div class="pronunciation-word-item mb-2 p-2 border border-amber-100 rounded">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">${word}</span>
                                    <button class="pronunciation-button small" data-text="${word}" onclick="speakKorean('${word.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                });
                
                formattedHTML += `</div>`;
                return formattedHTML;
            }
            
            // X·ª≠ l√Ω cho tr∆∞·ªùng h·ª£p ƒë∆°n gi·∫£n
            try {
                // T√¨m t·∫•t c·∫£ c√°c t·ª´ ti·∫øng H√†n trong chu·ªói
                const koreanWords = korean.split(/\s+/);
                const phoneticParts = phonetics.split(/\s+/);
                
                let html = '<div class="pronunciation-words-container">';
                
                // X·ª≠ l√Ω t·ª´ng t·ª´
                koreanWords.forEach((word, index) => {
                    html += `
                        <div class="pronunciation-word-item mb-2 p-2 bg-white rounded border border-amber-100">
                            <div class="flex items-center justify-between">
                                <span class="korean-word-text font-medium">${word}</span>
                                <button class="pronunciation-button small" data-text="${word}" onclick="speakKorean('${word.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                            </div>
                            <div class="korean-word-phonetic text-sm text-amber-700 italic">${index < phoneticParts.length ? phoneticParts[index] : ''}</div>
                        </div>
                    `;
                });
            
            html += '</div>';
            return html;
            } catch (e) {
                console.error('L·ªói khi ƒë·ªãnh d·∫°ng ph√°t √¢m chi ti·∫øt:', e);
                // Tr·∫£ v·ªÅ d·∫°ng ƒë∆°n gi·∫£n nh·∫•t
                return `<p class="font-medium">${phonetics}</p>`;
            }
        }

        // X·ª≠ l√Ω hi·ªÉn th·ªã ph√°t √¢m cho ph·∫ßn Ph√°t √¢m ·ªü cu·ªëi trang
        function displayPronunciationSection(data) {
            // Hi·ªÉn th·ªã ph·∫ßn ph√°t √¢m ·ªü cu·ªëi
            if (data && data.pronunciation_details) {
                const pronunciationSection = document.getElementById('pronunciation-section');
                const pronunciationContent = document.getElementById('pronunciation-content');
                
                if (pronunciationSection && pronunciationContent) {
                    let html = `
                    <div class="bg-amber-50 p-4 rounded-lg">
                        <h3 class="text-lg font-medium text-amber-800 mb-3"><i class="fas fa-comments mr-2"></i> H∆∞·ªõng d·∫´n ph√°t √¢m</h3>
                        <div class="space-y-4">
                    `;
                    
                    // Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n chung
                    if (data.pronunciation_guide) {
                        html += `
                        <div class="pronunciation-guide-box bg-white p-3 rounded-md border border-amber-200">
                            <h4 class="font-medium text-amber-700 mb-2"><i class="fas fa-info-circle mr-1"></i> L∆∞u √Ω ph√°t √¢m:</h4>
                            <div class="text-gray-700">${data.pronunciation_guide}</div>
                        </div>
                        `;
                    }
                    
                    // Hi·ªÉn th·ªã chi ti·∫øt ph√°t √¢m t·ª´ng √¢m
                    if (Array.isArray(data.pronunciation_details)) {
                        html += `<div class="pronunciation-details-list space-y-3">`;
                        
                        data.pronunciation_details.forEach(detail => {
                            html += `
                            <div class="pronunciation-detail-item bg-white p-3 rounded-md border border-amber-100 flex items-center">
                                <div class="flex-grow">
                                    <div class="font-medium text-amber-800">${detail.sound || ''}</div>
                                    <div class="text-gray-600 text-sm">${detail.description || ''}</div>
                                    ${detail.examples ? `
                                    <div class="mt-1 flex flex-wrap gap-1">
                                        ${detail.examples.map(ex => `
                                        <span class="pronunciation-example cursor-pointer" 
                                              onclick="speakKorean('${ex.replace(/'/g, "\\'")}')">
                                            ${ex} <i class="fas fa-volume-up text-xs ml-1 text-amber-500"></i>
                                        </span>`).join('')}
                                    </div>` : ''}
                                </div>
                                <button class="pronunciation-button" data-text="${(detail.sound || '').replace(/"/g, '&quot;')}">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                            </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                    
                    html += `
                        </div>
                    </div>
                    `;
                    
                    pronunciationContent.innerHTML = html;
                    pronunciationSection.style.display = 'block';
                    
                    // Kh·ªüi t·∫°o l·∫°i n√∫t ph√°t √¢m
                    setupPronunciationButtons();
                }
            }
        }

        // X·ª≠ l√Ω hi·ªÉn th·ªã v√† ph√°t √¢m cho c√°c v√≠ d·ª• ti·∫øng H√†n trong trang detail
        function setupExamplePronunciation() {
            // Ch·ªçn t·∫•t c·∫£ c√°c v√≠ d·ª• ti·∫øng H√†n tr√™n trang
            const exampleItems = document.querySelectorAll('.example-item');
            
            exampleItems.forEach(item => {
                // T√¨m ph·∫ßn ti·∫øng H√†n trong v√≠ d·ª•
                const koreanText = item.querySelector('.example-korean, .korean-text');
                
                // N·∫øu kh√¥ng c√≥ n√∫t ph√°t √¢m, th√™m v√†o
                if (koreanText && !item.querySelector('.pronunciation-button')) {
                    const text = koreanText.textContent.trim();
                    
                    // T·∫°o n√∫t ph√°t √¢m
                    const button = document.createElement('button');
                    button.className = 'pronunciation-button';
                    button.setAttribute('data-text', text);
                    button.innerHTML = '<i class="fas fa-volume-up"></i>';
                    
                    // Th√™m n√∫t v√†o ph·∫ßn t·ª≠
                    item.appendChild(button);
                }
            });
            
            // Kh·ªüi t·∫°o l·∫°i n√∫t ph√°t √¢m
            setupPronunciationButtons();
        }

        // Th√™m v√†o h√†m x·ª≠ l√Ω khi trang ƒë√£ t·∫£i xong
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Kh·ªüi t·∫°o c√°c n√∫t ph√°t √¢m tr√™n trang
            setupExamplePronunciation();
            
            // Th√™m favicon ƒë·ªÉ tr√°nh l·ªói 404
            const favicon = document.createElement('link');
            favicon.rel = 'icon';
            favicon.href = '/static/favicon.ico';
            favicon.type = 'image/x-icon';
            document.head.appendChild(favicon);
        });

        // C·∫≠p nh·∫≠t h√†m hi·ªÉn th·ªã v√≠ d·ª• ƒë·ªÉ x·ª≠ l√Ω c√°c tr∆∞·ªùng h·ª£p kh√°c nhau
        function renderExamples(examples) {
            if (!examples || !Array.isArray(examples) || examples.length === 0) {
                return '<p class="text-gray-500 italic">Kh√¥ng c√≥ v√≠ d·ª•.</p>';
            }
            
            let html = '<div class="space-y-3">';
            
            examples.forEach((example, index) => {
                // Ki·ªÉm tra xem example c√≥ ph·∫£i l√† chu·ªói hay object
                let koreanText, pronunciation, meaningText;
                
                if (typeof example === 'string') {
                    // Tr∆∞·ªùng h·ª£p v√≠ d·ª• l√† chu·ªói ƒë∆°n gi·∫£n
                    // T√°ch ph·∫ßn ti·∫øng H√†n v√† ph·∫ßn d·ªãch (n·∫øu c√≥)
                    const parts = example.split(' - ');
                    koreanText = parts[0];
                    meaningText = parts.length > 1 ? parts.slice(1).join(' - ') : '';
                    
                    // Ki·ªÉm tra xem c√≥ c·∫•u tr√∫c phi√™n √¢m kh√¥ng
                    const phoneticsMatch = koreanText.match(/(.+)\s*\((.+)\)/);
                    if (phoneticsMatch) {
                        koreanText = phoneticsMatch[1];
                        pronunciation = phoneticsMatch[2];
                    }
                } else {
                    // Tr∆∞·ªùng h·ª£p v√≠ d·ª• l√† object
                    koreanText = example.korean || example.hangul || '';
                    pronunciation = example.pronunciation || example.roman || '';
                    meaningText = example.meaning || example.vietnamese || '';
                }
                    
                    html += `
                    <div class="example-item p-3 bg-white rounded-md border border-blue-100 hover:border-blue-300 transition-colors">
                        <div class="flex items-center justify-between mb-1">
                            <div class="example-korean font-medium text-blue-800">${koreanText}</div>
                            <button class="pronunciation-button small" data-text="${koreanText}" onclick="speakKorean('${koreanText.replace(/'/g, "\\'")}')">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                        ${pronunciation ? `<div class="example-pronunciation text-sm text-gray-600 italic">${pronunciation}</div>` : ''}
                        ${meaningText ? `<div class="example-translation text-gray-700 mt-1">${meaningText}</div>` : ''}
                        </div>
                    `;
            });
            
            html += '</div>';
            return html;
        }

        // H√†m t·∫°o phi√™n √¢m ƒë∆°n gi·∫£n t·ª´ ti·∫øng H√†n
        function createRomanizationFromKorean(koreanText) {
            // B·∫£ng chuy·ªÉn ƒë·ªïi ƒë∆°n gi·∫£n t·ª´ Hangul sang phi√™n √¢m Latin
            const koreanCharMap = {
                '„Ñ±': 'g', '„Ñ≤': 'kk', '„Ñ¥': 'n', '„Ñ∑': 'd', '„Ñ∏': 'tt',
                '„Ñπ': 'r', '„ÖÅ': 'm', '„ÖÇ': 'b', '„ÖÉ': 'pp', '„ÖÖ': 's',
                '„ÖÜ': 'ss', '„Öá': '', '„Öà': 'j', '„Öâ': 'jj', '„Öä': 'ch',
                '„Öã': 'k', '„Öå': 't', '„Öç': 'p', '„Öé': 'h',
                '„Öè': 'a', '„Öê': 'ae', '„Öë': 'ya', '„Öí': 'yae', '„Öì': 'eo',
                '„Öî': 'e', '„Öï': 'yeo', '„Öñ': 'ye', '„Öó': 'o', '„Öò': 'wa',
                '„Öô': 'wae', '„Öö': 'oe', '„Öõ': 'yo', '„Öú': 'u', '„Öù': 'wo',
                '„Öû': 'we', '„Öü': 'wi', '„Ö†': 'yu', '„Ö°': 'eu', '„Ö¢': 'ui',
                '„Ö£': 'i'
            };
            
            // C√°c t·ª´ v√† c·ª•m t·ª´ c·ª• th·ªÉ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a s·∫µn
            const commonWords = {
                // C√°c t·ª´ trong v√≠ d·ª•
                'Ìò∏ÎëêÎ•º': 'hodureul', 'Î®πÎã§': 'meokda', 
                'Ïù¥ Î∂ÄÎ∂ÑÏùÑ': 'i bubuneul', 'ÎπºÎã§': 'ppaeda', 
                'Í∑∏ Î¨∏Ï†úÏóê': 'geu munjee', 'Í∞úÏùòÌïòÏßÄ ÎßàÏÑ∏Ïöî': 'gaeuihaji maseyo', 
                'Ï¢ãÏùÄ ÏÜåÏãùÏùÑ': 'jo-eun sosigeul', 'Î∞îÎùºÎã§': 'barada', 
                'ÏßÄÍ∞ëÏùÑ': 'jigabeul', 'ÏûÉÏñ¥Î≤ÑÎ¶¨Îã§': 'ireobeorida', 
                'Í∏∏ÏóêÏÑú': 'gireseo', 'ÎèôÏ†ÑÏùÑ': 'dongjeon-eul', 'Ï§çÎã§': 'jupda', 
                'Ï∂îÏÑùÏùÄ': 'chuseogeun', 'ÌïúÍµ≠Ïùò': 'hangugi', 'Î™ÖÏ†àÏù¥Îã§': 'myeongjeo-rida',
                
                // C√°c t·ª´ ƒë∆°n l·∫ª
                'Ìò∏Îëê': 'hodu', 'Î∂ÄÎ∂Ñ': 'bubun', 'Î¨∏Ï†ú': 'munje', 
                'Í∞úÏùòÌïòÎã§': 'gaeuihada', 'Í∞úÏùòÌïòÏßÄ': 'gaeuihaji', 'ÏïäÎã§': 'anta',
                'ÏÜåÏãù': 'sosik', 'Î∞îÎùºÎã§': 'barada', 'ÏßÄÍ∞ë': 'jigap', 
                'ÏûÉÏñ¥Î≤ÑÎ¶¨Îã§': 'ireobeorida', 'Í∏∏': 'gil', 'ÎèôÏ†Ñ': 'dongjeon', 
                'Ï∂îÏÑù': 'chuseok', 'Î™ÖÏ†à': 'myeongjeol',
                'Ï¢ãÏùÄ': 'jo-eun', 'ÏÜåÏãùÏùÑ': 'sosigeul', 
                
                // T·ª´ c√°c v√≠ d·ª• c·ª• th·ªÉ
                'Ìò∏ÎëêÎ•º Î®πÎã§': 'hodureul meokda',
                'Ïù¥ Î∂ÄÎ∂ÑÏùÑ ÎπºÎã§': 'i bubuneul ppaeda',
                'Í∑∏ Î¨∏Ï†úÎ•º Í∞úÏùòÌïòÏßÄ ÏïäÎã§': 'geu munjerul gaeuihaji anta',
                'Í∑∏ Î¨∏Ï†úÏóê Í∞úÏùòÌïòÏßÄ ÏïäÎã§': 'geu munjee gaeuihaji anta',
                'Ï¢ãÏùÄ ÏÜåÏãùÏùÑ Î∞îÎùºÎã§': 'jo-eun sosigeul barada',
                'ÏßÄÍ∞ëÏùÑ ÏûÉÏñ¥Î≤ÑÎ¶¨Îã§': 'jigabeul ireobeorida',
                'Í∏∏ÏóêÏÑú ÎèôÏ†ÑÏùÑ Ï§çÎã§': 'gireseo dongjeon-eul jupda',
                'Ï∂îÏÑùÏùÄ ÌïúÍµ≠Ïùò Î™ÖÏ†àÏù¥Îã§': 'chuseogeun hangugi myeongjeolida',
                
                // T√™n d√¢n t·ªôc v√† v√πng mi·ªÅn
                'ÌïúÍµ≠': 'hanguk', 'ÌïúÍµ≠Ïùò': 'hangugi', 'ÌïúÍµ≠Ïñ¥': 'hangugeo',
                'ÏÑúÏö∏': 'seoul', 'Î∂ÄÏÇ∞': 'busan', 'ÎåÄÍµ¨': 'daegu',
                
                // C√°c t·ª´ ph·ªï bi·∫øn kh√°c
                'ÏïàÎÖïÌïòÏÑ∏Ïöî': 'annyeonghaseyo', 'Í∞êÏÇ¨Ìï©ÎãàÎã§': 'gamsahamnida',
                'ÎØ∏ÏïàÌï©ÎãàÎã§': 'mianhamnida', 'ÏÇ¨ÎûëÌï©ÎãàÎã§': 'saranghamnida',
                'ÎÑ§': 'ne', 'ÏïÑÎãàÏöî': 'aniyo', 'Í¥úÏ∞ÆÏïÑÏöî': 'gwaenchanayo',
                'Ïã§Î°ÄÌï©ÎãàÎã§': 'sillyehamnida', 'Ïûò ÏßÄÎÇ¥Ïöî': 'jal jinaeyo',
                'ÎßõÏûàÏñ¥Ïöî': 'masisseoyo', 'Ïûò Î®πÍ≤†ÏäµÎãàÎã§': 'jal meokgesseumnida',
                'Ïù¥Î¶Ñ': 'ireum', 'ÎÇòÏù¥': 'nai', 'ÏßÅÏóÖ': 'jigeop',
                'ÌïôÏÉù': 'haksaeng', 'ÏÑ†ÏÉùÎãò': 'seonsaengnim', 'ÏπúÍµ¨': 'chingu'
            };
            
            // Ki·ªÉm tra tr∆∞·ªõc n·∫øu to√†n b·ªô chu·ªói c√≥ trong t·ª´ ƒëi·ªÉn
            if (commonWords[koreanText]) {
                return commonWords[koreanText];
            }
            
            // T√°ch c√°c t·ª´ trong vƒÉn b·∫£n ƒë·ªÉ ph√¢n t√≠ch ri√™ng
            const words = koreanText.split(/\s+/);
            let romanization = [];
            
            // Th·ª≠ t√¨m phi√™n √¢m cho m·ªói t·ª´
            words.forEach(word => {
                if (commonWords[word]) {
                    romanization.push(commonWords[word]);
                } else {
                    romanization.push(word);
                }
            });
            
            return romanization.join(' ');
        }

        // X·ª≠ l√Ω hi·ªÉn th·ªã v√† ph√°t √¢m cho c√°c v√≠ d·ª• ti·∫øng H√†n trong trang detail
        function setupExamplePronunciation() {
            // Ch·ªçn t·∫•t c·∫£ c√°c v√≠ d·ª• ti·∫øng H√†n tr√™n trang
            const exampleItems = document.querySelectorAll('.example-item');
            
            exampleItems.forEach(item => {
                // T√¨m ph·∫ßn ti·∫øng H√†n trong v√≠ d·ª•
                const koreanText = item.querySelector('.example-korean, .korean-text');
                
                // N·∫øu kh√¥ng c√≥ n√∫t ph√°t √¢m, th√™m v√†o
                if (koreanText && !item.querySelector('.pronunciation-button')) {
                    const text = koreanText.textContent.trim();
                    
                    // T·∫°o n√∫t ph√°t √¢m
                    const button = document.createElement('button');
                    button.className = 'pronunciation-button';
                    button.setAttribute('data-text', text);
                    button.innerHTML = '<i class="fas fa-volume-up"></i>';
                    
                    // T√¨m container ƒë·ªÉ th√™m n√∫t v√†o
                    const container = item.querySelector('.example-content') || item;
                    
                    // Th√™m n√∫t v√†o ph·∫ßn t·ª≠
                    if (container !== item) {
                        const buttonContainer = document.createElement('div');
                        buttonContainer.className = 'flex justify-between items-center mt-2';
                        buttonContainer.appendChild(button);
                        container.appendChild(buttonContainer);
                    } else {
                        item.appendChild(button);
                    }
                    
                    // Th√™m phi√™n √¢m n·∫øu ch∆∞a c√≥
                    if (!item.querySelector('.example-pronunciation')) {
                        const pronunciation = createRomanizationFromKorean(text);
                        const pronunciationElem = document.createElement('div');
                        pronunciationElem.className = 'example-pronunciation text-gray-500 italic text-sm';
                        pronunciationElem.textContent = pronunciation;
                        
                        // Ch√®n sau ph·∫ßn ti·∫øng H√†n
                        if (koreanText.nextSibling) {
                            koreanText.parentNode.insertBefore(pronunciationElem, koreanText.nextSibling);
                        } else {
                            koreanText.parentNode.appendChild(pronunciationElem);
                        }
                    }
                }
            });
            
            // Kh·ªüi t·∫°o l·∫°i n√∫t ph√°t √¢m
            setupPronunciationButtons();
        }

        // C·∫≠p nh·∫≠t l·∫°i h√†m hi·ªÉn th·ªã k·∫øt qu·∫£ ƒë·ªÉ x·ª≠ l√Ω l·ªói khi hi·ªÉn th·ªã v√≠ d·ª•
        function handleExampleSection(data, examplesSection, examplesContent) {
            if (!data.examples || !data.examples.length || !examplesSection || !examplesContent) return;
            
            try {
                examplesContent.innerHTML = renderExamples(data.examples);
                examplesSection.style.display = 'block';
                
                // Kh·ªüi t·∫°o l·∫°i n√∫t ph√°t √¢m trong c√°c v√≠ d·ª•
                setupExamplePronunciation();
            } catch (error) {
                console.error('L·ªói khi hi·ªÉn th·ªã v√≠ d·ª•:', error);
            }
        }

        // H√†m hi·ªÉn th·ªã th√¥ng b√°o l·ªói trong DOM
        function displayDOMError(message, elementId) {
            console.error(`L·ªói DOM: ${message} (Element ID: ${elementId})`);
            
            // T·∫°o ph·∫ßn t·ª≠ th√¥ng b√°o l·ªói
            const errorDiv = document.createElement('div');
            errorDiv.className = 'p-4 my-4 bg-red-50 border border-red-200 rounded-md text-red-700';
            errorDiv.innerHTML = `
                <div class="flex items-center mb-2">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                    <strong>L·ªói hi·ªÉn th·ªã n·ªôi dung</strong>
                </div>
                <p>${message}</p>
                <p class="text-xs mt-1">ElementID: ${elementId || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                <button class="mt-2 px-3 py-1 bg-red-100 hover:bg-red-200 rounded text-sm" onclick="location.reload()">
                    <i class="fas fa-sync-alt mr-1"></i> T·∫£i l·∫°i trang
                </button>
            `;
            
            // Th√™m th√¥ng b√°o v√†o ph·∫ßn t·ª≠ results n·∫øu c√≥
            const resultsDiv = document.getElementById('results');
            if (resultsDiv) {
                resultsDiv.prepend(errorDiv);
                resultsDiv.classList.remove('hidden');
            } else {
                // N·∫øu kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ results, th√™m v√†o body
                document.body.prepend(errorDiv);
            }
        }

        // H√†m ki·ªÉm tra t·ªìn t·∫°i c·ªßa ph·∫ßn t·ª≠ DOM
        function validateElement(elementId, elementName) {
            const element = document.getElementById(elementId);
            if (!element) {
                displayDOMError(`Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ ${elementName || elementId} tr√™n trang.`, elementId);
                return null;
            }
            return element;
        }

        // H√†m hi·ªÉn th·ªã ph·∫ßn t·ª≠ v·ªõi ki·ªÉm tra t·ªìn t·∫°i
        function showElementSafely(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
                return true;
            } else {
                displayDOMError(`Kh√¥ng th·ªÉ hi·ªÉn th·ªã ph·∫ßn t·ª≠ ${elementId} v√¨ kh√¥ng t√¨m th·∫•y tr√™n trang.`, elementId);
                return false;
            }
        }

        // C·∫£i thi·ªán h√†m reset k·∫øt qu·∫£ ƒë·ªÉ x·ª≠ l√Ω an to√†n
        function resetResultsSafely() {
            try {
                // ·∫®n t·∫•t c·∫£ c√°c ph·∫ßn k·∫øt qu·∫£
                document.querySelectorAll('.result-section').forEach(section => {
                    if (section) {
                        section.style.display = 'none';
                    }
                });
                
                // Reset n·ªôi dung c√°c ph·∫ßn b·∫±ng c√°ch s·ª≠ d·ª•ng h√†m ki·ªÉm tra an to√†n
                const elements = [
                    { id: 'conversationContent', name: 'N·ªôi dung h·ªôi tho·∫°i' },
                    { id: 'vocabContent', name: 'N·ªôi dung t·ª´ v·ª±ng' },
                    { id: 'grammarContent', name: 'N·ªôi dung ng·ªØ ph√°p' },
                    { id: 'translationContent', name: 'N·ªôi dung d·ªãch thu·∫≠t' },
                    { id: 'examplesContent', name: 'N·ªôi dung v√≠ d·ª•' },
                    { id: 'cultureContent', name: 'N·ªôi dung vƒÉn h√≥a' },
                    { id: 'pronunciationContent', name: 'N·ªôi dung ph√°t √¢m' },
                    { id: 'mnemonicsContent', name: 'N·ªôi dung ghi nh·ªõ' },
                    { id: 'lessonTopic', name: 'Ch·ªß ƒë·ªÅ b√†i h·ªçc' }
                ];
                
                elements.forEach(el => {
                    const element = document.getElementById(el.id);
                    if (element) {
                        element.innerHTML = '';
                    }
                });
                
                console.log('ƒê√£ reset t·∫•t c·∫£ c√°c ph·∫ßn k·∫øt qu·∫£.');
            } catch (error) {
                console.error('L·ªói khi reset k·∫øt qu·∫£:', error);
            }
        }

        // C·∫≠p nh·∫≠t h√†m speakKorean ƒë·ªÉ h·ªó tr·ª£ ph√°t √¢m c·∫£ ti·∫øng H√†n v√† ti·∫øng Vi·ªát
        function speakKorean(text, callback, includeTranslation = true) {
            if (!text) return;
            
            // D·ª´ng ph√°t √¢m hi·ªán t·∫°i n·∫øu c√≥
            window.speechSynthesis.cancel();
            
            // L·∫•y t·ªëc ƒë·ªô ph√°t √¢m t·ª´ thanh tr∆∞·ª£t
            const speedControl = document.getElementById('pronunciation-speed');
            const rate = speedControl ? parseFloat(speedControl.value) : 1.0;
            
            // Ki·ªÉm tra xem c√≥ y√™u c·∫ßu ph√°t c·∫£ b·∫£n d·ªãch kh√¥ng
            if (includeTranslation) {
                // T√¨m b·∫£n d·ªãch ti·∫øng Vi·ªát khi nh·∫•n n√∫t ph√°t √¢m t·ª´ v√≠ d·ª•
                let vietnameseText = '';
                const button = $(document.activeElement);
                
                if (button.hasClass('pronunciation-button')) {
                    // T√¨m ph·∫ßn t·ª≠ cha ch·ª©a v√≠ d·ª•
                    const exampleItem = button.closest('.example-item, .pronunciation-block');
                    if (exampleItem.length) {
                        // T√¨m ph·∫ßn d·ªãch ti·∫øng Vi·ªát
                        const translationElement = exampleItem.find('.example-translation');
                        if (translationElement.length) {
                            vietnameseText = translationElement.text().trim();
                        }
                    }
                }
                
                // Ph√°t √¢m ti·∫øng H√†n tr∆∞·ªõc
                const koreanUtterance = new SpeechSynthesisUtterance(text);
                koreanUtterance.lang = 'ko-KR';
                koreanUtterance.rate = rate;
                
                // N·∫øu c√≥ b·∫£n d·ªãch ti·∫øng Vi·ªát, ph√°t sau khi ti·∫øng H√†n k·∫øt th√∫c
                if (vietnameseText) {
                    koreanUtterance.onend = function() {
                        // T·∫°m d·ª´ng gi·ªØa hai ph·∫ßn ph√°t √¢m
                        setTimeout(function() {
                            // Ph√°t √¢m ti·∫øng Vi·ªát
                            const vietnameseUtterance = new SpeechSynthesisUtterance(vietnameseText);
                            vietnameseUtterance.lang = 'vi-VN';
                            vietnameseUtterance.rate = rate * 0.9; // Gi·∫£m t·ªëc ƒë·ªô m·ªôt ch√∫t cho ti·∫øng Vi·ªát
                            
                            // Th√™m callback khi k·∫øt th√∫c to√†n b·ªô qu√° tr√¨nh ph√°t √¢m
                            if (typeof callback === 'function') {
                                vietnameseUtterance.onend = callback;
                            }
                            
                            // Ph√°t √¢m ti·∫øng Vi·ªát
                            window.speechSynthesis.speak(vietnameseUtterance);
                        }, 800); // D·ª´ng 800ms gi·ªØa ti·∫øng H√†n v√† ti·∫øng Vi·ªát
                    };
                    
                    // B·∫Øt ƒë·∫ßu ph√°t √¢m ti·∫øng H√†n
                    window.speechSynthesis.speak(koreanUtterance);
                } else {
                    // N·∫øu kh√¥ng c√≥ b·∫£n d·ªãch, ch·ªâ ph√°t ti·∫øng H√†n
                    if (typeof callback === 'function') {
                        koreanUtterance.onend = callback;
                    }
                    window.speechSynthesis.speak(koreanUtterance);
                }
            } else {
                // Ch·∫ø ƒë·ªô ch·ªâ ph√°t ti·∫øng H√†n (tr∆∞·ªùng h·ª£p c≈©)
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                utterance.rate = rate;
                
                // Th√™m callback khi k·∫øt th√∫c ph√°t √¢m
                if (typeof callback === 'function') {
                    utterance.onend = callback;
                }
                
                // B·∫Øt ƒë·∫ßu ph√°t √¢m
                window.speechSynthesis.speak(utterance);
            }
        }

        // ... existing code ...
        // Th√™m v√†o ph·∫ßn controls t·ªëc ƒë·ªô ph√°t √¢m
        const speedControlHtml = `
        <div id="global-pronunciation-settings" class="fixed bottom-4 right-4 p-2 bg-white rounded-lg shadow-lg border border-blue-300 z-50">
            <div class="flex items-center space-x-2">
                <label for="pronunciation-speed" class="text-sm font-medium text-gray-700">T·ªëc ƒë·ªô:</label>
                <input type="range" id="pronunciation-speed" min="0.5" max="1.5" step="0.1" value="0.8" class="w-24">
                <span id="speed-value" class="text-sm font-medium text-blue-600">0.8x</span>
            </div>
        </div>
        `;

        // C·∫≠p nh·∫≠t h√†m speakKorean ƒë·ªÉ h·ªó tr·ª£ callback khi k·∫øt th√∫c
        // H√†m n√†y ƒë√£ ƒë∆∞·ª£c thay th·∫ø b·ªüi phi√™n b·∫£n m·ªõi ·ªü cu·ªëi file

        // C·∫≠p nh·∫≠t h√†m hi·ªÉn th·ªã v√≠ d·ª• ph√°t √¢m
        function displayPronunciationExamples(examples) {
            if (!examples || !examples.length) return '';
            
            let html = '<div class="pronunciation-examples mt-4">';
            html += '<h4 class="font-medium text-amber-700 mb-2"><i class="fas fa-graduation-cap mr-1"></i> V√≠ d·ª• ph√°t √¢m:</h4>';
            
            examples.forEach(example => {
                html += `
                <div class="pronunciation-block">
                    <div class="pronunciation-text">
                        <div class="korean-text">${example.korean}</div>
                        <div class="pronunciation-phonetics">${example.pronunciation || ''}</div>
                        <div class="example-translation text-gray-700 mt-1">${example.vietnamese || ''}</div>
                    </div>
                    <button class="pronunciation-button" data-text="${example.korean.replace(/"/g, '&quot;')}">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // C·∫≠p nh·∫≠t h√†m speakKorean ƒë·ªÉ ch·ªâ ph√°t √¢m ti·∫øng H√†n v√† kh√¥ng ph√°t √¢m ti·∫øng Vi·ªát
        function speakKorean(text, callback) {
            if (!text) return;
            
            // D·ª´ng ph√°t √¢m hi·ªán t·∫°i n·∫øu c√≥
            window.speechSynthesis.cancel();
            
            // L·∫•y t·ªëc ƒë·ªô ph√°t √¢m t·ª´ thanh tr∆∞·ª£t
            const speedControl = document.getElementById('pronunciation-speed');
            const rate = speedControl ? parseFloat(speedControl.value) : 1.0;
            
            // Ch·ªâ ph√°t √¢m ti·∫øng H√†n, kh√¥ng ph√°t √¢m ti·∫øng Vi·ªát
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = rate;
            
            // Th√™m callback khi k·∫øt th√∫c ph√°t √¢m
            if (typeof callback === 'function') {
                utterance.onend = callback;
            }
            
            // B·∫Øt ƒë·∫ßu ph√°t √¢m
            window.speechSynthesis.speak(utterance);
        }

        // ... existing code ...
        // C·∫≠p nh·∫≠t h√†m hi·ªÉn th·ªã ph√°t √¢m
        function displayPronunciationExamples(examples) {
            if (!examples || !Array.isArray(examples) || examples.length === 0) {
                return '';
            }
            
            let html = `
                <div class="mt-4">
                    <h4 class="font-medium text-amber-700 mb-2"><i class="fas fa-list-ul mr-1"></i> V√≠ d·ª• ph√°t √¢m:</h4>
                    <div class="space-y-2">
            `;
            
            examples.forEach(example => {
                const koreanText = example.korean || example.text || '';
                const pronunciation = example.pronunciation || '';
                const meaning = example.meaning || example.vietnamese || '';
                
                html += `
                    <div class="pronunciation-example p-2 bg-white rounded-md border border-amber-100">
                        <div class="flex items-center justify-between mb-1">
                            <div class="korean-text font-medium text-amber-800">${koreanText}</div>
                            <button class="pronunciation-button p-1 px-2" onclick="speakKorean('${koreanText.replace(/'/g, "\\'")}')">
                                <i class="fas fa-volume-up mr-1"></i> Nghe
                            </button>
                        </div>
                        <div class="pronunciation-phonetics text-sm text-amber-700 italic">${pronunciation}</div>
                        ${meaning ? `<div class="meaning text-sm text-gray-600 mt-1">${meaning}</div>` : ''}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        // H√†m ƒë·ªÉ x·ª≠ l√Ω hi·ªÉn th·ªã ph·∫ßn pronunciation-guide
        function handlePronunciationGuide(pronunciation) {
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p danh s√°ch c√°c t·ª´ c√°ch nhau b·∫±ng d·∫•u ph·∫©y
            if (pronunciation.includes(',')) {
                const words = pronunciation.split(',').map(word => word.trim()).filter(w => w);
                let html = '<div class="space-y-2">';
                
                words.forEach(word => {
                    // T√°ch ph·∫ßn ti·∫øng H√†n v√† phi√™n √¢m
                    const parts = word.split('(');
                    if (parts.length > 1) {
                        const korean = parts[0].trim();
                        const phonetic = parts[1].replace(')', '').trim();
                        
                        html += `
                        <div class="pronunciation-word flex items-center p-2 bg-white rounded border border-amber-100 group">
                            <div class="flex-grow">
                                <span class="korean-text font-medium">${korean}</span>
                                <span class="text-amber-700 italic ml-1">(${phonetic})</span>
                            </div>
                            <button class="pronunciation-button small ml-2 opacity-80 group-hover:opacity-100" onclick="speakKorean('${korean.replace(/'/g, "\\'")}')">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>`;
                    } else {
                        html += `
                        <div class="pronunciation-word flex items-center p-2 bg-white rounded border border-amber-100 group">
                            <div class="flex-grow">
                                <span class="korean-text font-medium">${word}</span>
                            </div>
                            <button class="pronunciation-button small ml-2 opacity-80 group-hover:opacity-100" onclick="speakKorean('${word.replace(/'/g, "\\'")}')">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>`;
                    }
                });
                
                html += '</div>';
                return html;
            }
            
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p m·∫∑c ƒë·ªãnh
            return `<span class="font-medium">${pronunciation}</span>`;
        }

        // Thi·∫øt l·∫≠p c√°c ƒëi·ªÅu khi·ªÉn ph√°t √¢m
        function setupPronunciationControls() {
            try {
                // T√¨m t·∫•t c·∫£ c√°c n√∫t ph√°t √¢m tr√™n trang
                const buttons = document.querySelectorAll('.pronunciation-button');
                buttons.forEach(button => {
                    // X√≥a event listeners c≈©
                    const newButton = button.cloneNode(true);
                    if (button.parentNode) {
                        button.parentNode.replaceChild(newButton, button);
                    }
                    
                    // Th√™m event listener m·ªõi
                    newButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        // L·∫•y text t·ª´ thu·ªôc t√≠nh data-text ho·∫∑c t·ª´ ph·∫ßn t·ª≠ g·∫ßn nh·∫•t
                        let text = this.getAttribute('data-text');
                        if (!text) {
                            const container = this.closest('.pronunciation-word, .example-item, .pronunciation-example');
                            if (container) {
                                const koreanText = container.querySelector('.korean-text, .example-korean, .korean-word-text');
                                if (koreanText) {
                                    text = koreanText.textContent;
                                }
                            }
                        }
                        
                        if (text) {
                            speakKorean(text);
                        }
                    });
                });
                
                // Ph√°t √¢m b√†i ho√†n ch·ªânh khi nh·∫•n v√†o n√∫t l·ªõn
                const fullPronunciationButton = document.querySelector('.pronunciation-button.large');
                if (fullPronunciationButton) {
                    fullPronunciationButton.addEventListener('click', function() {
                        const text = this.getAttribute('data-text');
                        if (text) {
                            speakKorean(text);
                        } else {
                            const guide = document.querySelector('.pronunciation-guide');
                            if (guide) {
                                const koreanText = guide.querySelector('.font-medium, .korean-original');
                                if (koreanText) {
                                    speakKorean(koreanText.textContent);
                                }
                            }
                        }
                    });
                }
                
                // X·ª≠ l√Ω hi·ªÉn th·ªã ph·∫ßn pronunciation guide
                document.querySelectorAll('.pronunciation-guide').forEach(guide => {
                    const content = guide.textContent.trim();
                    if (content.split(',').length > 1) {
                        guide.innerHTML = handlePronunciationGuide(content);
                    }
                });
                
                // C·∫≠p nh·∫≠t gi√° tr·ªã hi·ªÉn th·ªã t·ªëc ƒë·ªô ph√°t √¢m
                const speedControl = document.getElementById('pronunciation-speed');
                const speedValue = document.getElementById('speed-value');
                
                if (speedControl && speedValue) {
                    speedControl.addEventListener('input', function() {
                        speedValue.textContent = `${speedControl.value}x`;
                    });
                }
                
                // X·ª≠ l√Ω hi·ªÉn th·ªã/·∫©n b·∫£ng c√†i ƒë·∫∑t
                const settingsToggle = document.querySelector('.pronunciation-settings');
                if (settingsToggle) {
                    settingsToggle.addEventListener('click', function() {
                        togglePronunciationSettings();
                    });
                }
            } catch (e) {
                console.error('L·ªói khi thi·∫øt l·∫≠p ƒëi·ªÅu khi·ªÉn ph√°t √¢m:', e);
            }
        }

        // C·∫≠p nh·∫≠t h√†m th√™m n√∫t ph√°t √¢m cho v√≠ d·ª• hi·ªÉn th·ªã trong trang
        function setupPronunciationButtons() {
            try {
                // Thi·∫øt l·∫≠p c√°c n√∫t ph√°t √¢m
                document.querySelectorAll('.pronunciation-button').forEach(button => {
                    if (!button.hasAttribute('data-initialized')) {
                        button.setAttribute('data-initialized', 'true');
                        
                        button.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            // T√¨m text ƒë·ªÉ ph√°t √¢m
                            let textToSpeak = button.getAttribute('data-text');
                            
                            if (!textToSpeak) {
                                // T√¨m trong c√°c ph·∫ßn t·ª≠ l√¢n c·∫≠n
                                const container = button.closest('.example-item, .pronunciation-block, .pronunciation-word, .korean-phonetic-word, .pronunciation-example');
                                if (container) {
                                    const textElement = container.querySelector('.example-korean, .korean-text, .korean-word-text');
                                    if (textElement) {
                                        textToSpeak = textElement.textContent;
                                    }
                                }
                            }
                            
                            if (textToSpeak) {
                                speakKorean(textToSpeak);
                                
                                // Hi·ªáu ·ª©ng khi ƒëang ph√°t √¢m
                                button.classList.add('playing');
                                setTimeout(() => {
                                    button.classList.remove('playing');
                                }, 1500);
                            }
                        });
                    }
                });
                
                console.log(`ƒê√£ thi·∫øt l·∫≠p c√°c n√∫t ph√°t √¢m tr√™n trang.`);
            } catch (error) {
                console.error('L·ªói khi thi·∫øt l·∫≠p n√∫t ph√°t √¢m:', error);
            }
        }

        // ƒê·∫£m b·∫£o ch·∫°y l·∫°i h√†m thi·∫øt l·∫≠p sau khi hi·ªÉn th·ªã k·∫øt qu·∫£
        document.addEventListener('DOMContentLoaded', function() {
            setupPronunciationControls();
            
            // Thi·∫øt l·∫≠p s·ª± ki·ªán cho c√°c ph·∫ßn t·ª≠ ƒë∆∞·ª£c th√™m v√†o DOM sau n√†y
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length) {
                        setupPronunciationButtons();
                    }
                });
            });
            
            // Theo d√µi thay ƒë·ªïi trong container k·∫øt qu·∫£
            const resultsContainer = document.getElementById('results');
            if (resultsContainer) {
                observer.observe(resultsContainer, { childList: true, subtree: true });
            }
            
            console.log(`ƒê√£ kh·ªüi t·∫°o theo d√µi thay ƒë·ªïi DOM cho container k·∫øt qu·∫£.`);
            
            // Thi·∫øt l·∫≠p ban ƒë·∫ßu cho c√°c n√∫t ph√°t √¢m
            setupPronunciationButtons();
        });

        // Thi·∫øt l·∫≠p n√∫t ph√°t √¢m cho c√°c v√≠ d·ª•
        function setupExamplePronunciation() {
            try {
                document.querySelectorAll('.example-item .pronunciation-button').forEach(button => {
                    if (!button.hasAttribute('data-initialized')) {
                        button.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            // Thi·∫øt l·∫≠p giao di·ªán khi ph√°t √¢m
                            document.querySelectorAll('.example-item .pronunciation-button').forEach(btn => {
                                btn.classList.remove('playing');
                            });
                            document.querySelectorAll('.example-korean').forEach(text => {
                                text.classList.remove('playing-text');
                            });
                            
                            // Highlight v√≠ d·ª• ƒëang ph√°t √¢m
                            const exampleItem = this.closest('.example-item');
                            const koreanText = exampleItem.querySelector('.example-korean');
                            
                            if (koreanText) {
                                koreanText.classList.add('playing-text');
                            }
                            this.classList.add('playing');
                            
                            // L·∫•y n·ªôi dung ti·∫øng H√†n ƒë·ªÉ ph√°t √¢m
                            const textToSpeak = this.dataset.text || koreanText.textContent;
                            
                            // Ph√°t √¢m v·ªõi callback khi k·∫øt th√∫c
                            if (textToSpeak) {
                                speakKorean(textToSpeak, () => {
                                    // X√≥a tr·∫°ng th√°i highlight khi k·∫øt th√∫c
                                    this.classList.remove('playing');
                                    if (koreanText) {
                                        koreanText.classList.remove('playing-text');
                                    }
                                }, true);
                            }
                        });
                        
                        // ƒê√°nh d·∫•u ƒë√£ kh·ªüi t·∫°o
                        button.setAttribute('data-initialized', 'true');
                    }
                });
                
                console.log('ƒê√£ kh·ªüi t·∫°o c√°c n√∫t ph√°t √¢m cho v√≠ d·ª•.');
            } catch (error) {
                console.error('L·ªói khi thi·∫øt l·∫≠p n√∫t ph√°t √¢m cho v√≠ d·ª•:', error);
            }
        }

        // C·∫£i thi·ªán h√†m reset k·∫øt qu·∫£ ƒë·ªÉ x·ª≠ l√Ω an to√†n v√† kh√¥i ph·ª•c c·∫•u tr√∫c DOM n·∫øu c·∫ßn
        function resetResultsSafely() {
            try {
                // Ki·ªÉm tra v√† t·∫°o l·∫°i c√°c section n·∫øu ch√∫ng kh√¥ng t·ªìn t·∫°i
                const resultsDiv = document.getElementById('results');
                if (!resultsDiv) {
                    console.error('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ results');
                    return;
                }
                
                // Danh s√°ch c√°c section c·∫ßn ki·ªÉm tra
                const sections = [
                    { id: 'conversation-section', title: 'H·ªôi tho·∫°i', icon: 'comments', contentId: 'conversationContent' },
                    { id: 'vocab-section', title: 'T·ª´ v·ª±ng', icon: 'book', contentId: 'vocabContent' },
                    { id: 'grammar-section', title: 'Ng·ªØ ph√°p', icon: 'feather-alt', contentId: 'grammarContent' },
                    { id: 'translation-section', title: 'D·ªãch thu·∫≠t', icon: 'language', contentId: 'translationContent' },
                    { id: 'examples-section', title: 'V√≠ d·ª•', icon: 'lightbulb', contentId: 'examplesContent' },
                    { id: 'culture-section', title: 'VƒÉn h√≥a', icon: 'landmark', contentId: 'cultureContent' },
                    { id: 'pronunciation-section', title: 'Ph√°t √¢m', icon: 'volume-up', contentId: 'pronunciationContent' },
                    { id: 'lesson-section', title: 'B√†i h·ªçc ng·ªØ ph√°p', icon: 'chalkboard-teacher', contentId: 'lessonTopic' },
                    { id: 'mnemonics-section', title: 'Ph∆∞∆°ng ph√°p ghi nh·ªõ', icon: 'brain', contentId: 'mnemonicsContent' }
                ];
                
                // Ki·ªÉm tra v√† kh√¥i ph·ª•c c√°c section
                sections.forEach(section => {
                    let sectionElement = document.getElementById(section.id);
                    
                    // N·∫øu section kh√¥ng t·ªìn t·∫°i, t·∫°o m·ªõi
                    if (!sectionElement) {
                        console.log(`T·∫°o l·∫°i section ${section.id}`);
                        sectionElement = document.createElement('div');
                        sectionElement.id = section.id;
                        sectionElement.className = 'result-section';
                        sectionElement.style.display = 'none';
                        
                        // T·∫°o ti√™u ƒë·ªÅ
                        const titleElement = document.createElement('h3');
                        titleElement.innerHTML = `<i class="fas fa-${section.icon} text-blue-600"></i> ${section.title}`;
                        sectionElement.appendChild(titleElement);
                        
                        // T·∫°o div n·ªôi dung
                        const contentDiv = document.createElement('div');
                        contentDiv.id = section.contentId;
                        sectionElement.appendChild(contentDiv);
                        
                        // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho lesson-section
                        if (section.id === 'lesson-section') {
                            createLessonSectionContent(sectionElement);
                        }
                        
                        // Th√™m v√†o results
                        resultsDiv.appendChild(sectionElement);
                    } else {
                        // N·∫øu section t·ªìn t·∫°i, ·∫©n ƒëi
                        sectionElement.style.display = 'none';
                        
                        // Ki·ªÉm tra content div
                        const contentDiv = document.getElementById(section.contentId);
                        if (!contentDiv) {
                            console.log(`T·∫°o l·∫°i div n·ªôi dung ${section.contentId}`);
                            const newContentDiv = document.createElement('div');
                            newContentDiv.id = section.contentId;
                            sectionElement.appendChild(newContentDiv);
                        } else {
                            // X√≥a n·ªôi dung c≈©
                            contentDiv.innerHTML = '';
                        }
                    }
                });
                
                // Ki·ªÉm tra v√† kh√¥i ph·ª•c c√°c ph·∫ßn t·ª≠ con c·ªßa lesson-section
                const lessonSection = document.getElementById('lesson-section');
                if (lessonSection) {
                    const lessonTopicElement = document.getElementById('lessonTopic');
                    if (!lessonTopicElement) {
                        createLessonSectionContent(lessonSection);
                    }
                }
                
                console.log('ƒê√£ reset v√† kh√¥i ph·ª•c c·∫•u tr√∫c DOM cho t·∫•t c·∫£ c√°c ph·∫ßn k·∫øt qu·∫£.');
            } catch (error) {
                console.error('L·ªói khi reset k·∫øt qu·∫£:', error);
            }
        }
        
        // H√†m t·∫°o n·ªôi dung cho lesson-section
        function createLessonSectionContent(lessonSection) {
            // X√≥a n·ªôi dung c≈©
            lessonSection.innerHTML = '';
            
            // T·∫°o ti√™u ƒë·ªÅ
            const titleElement = document.createElement('h3');
            titleElement.innerHTML = '<i class="fas fa-chalkboard-teacher text-blue-600"></i> B√†i h·ªçc ng·ªØ ph√°p';
            lessonSection.appendChild(titleElement);
            
            // T·∫°o heading cho ch·ªß ƒë·ªÅ
            const topicHeading = document.createElement('h4');
            topicHeading.id = 'lessonTopic';
            topicHeading.className = 'font-semibold text-lg mb-2 text-blue-800';
            lessonSection.appendChild(topicHeading);
            
            // T·∫°o c√°c ph·∫ßn n·ªôi dung c·ªßa b√†i h·ªçc
            const lessonParts = [
                { id: 'lesson-definition', title: 'ƒê·ªãnh nghƒ©a', icon: 'info-circle', contentClass: 'definition-content' },
                { id: 'lesson-usage', title: 'C√°ch d√πng', icon: 'cog', contentClass: 'usage-content' },
                { id: 'lesson-comparison', title: 'So s√°nh', icon: 'balance-scale', contentClass: 'comparison-content' },
                { id: 'lesson-common_mistakes', title: 'L·ªói th∆∞·ªùng g·∫∑p', icon: 'exclamation-triangle', contentClass: 'common-mistakes-content' },
                { id: 'lesson-examples', title: 'V√≠ d·ª•', icon: 'list-ul', contentClass: 'examples-content' },
                { id: 'lesson-exercise', title: 'B√†i t·∫≠p', icon: 'pencil-alt', contentClass: 'exercise-content' }
            ];
            
            lessonParts.forEach(part => {
                const partContainer = document.createElement('div');
                partContainer.id = part.id;
                partContainer.className = 'mb-4';
                
                const partHeading = document.createElement('h5');
                partHeading.className = 'font-medium text-blue-700 mb-2';
                partHeading.innerHTML = `<i class="fas fa-${part.icon} mr-1"></i> ${part.title}:`;
                partContainer.appendChild(partHeading);
                
                const partContent = document.createElement('div');
                partContent.className = `${part.contentClass} pl-4 border-l-2 border-blue-200`;
                partContainer.appendChild(partContent);
                
                lessonSection.appendChild(partContainer);
            });
        }
    </script>
</body>
</html>